---
phase: 03-emisor-receptores-y-productos
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - app/Filament/Resources/ProductoResource.php
  - app/Filament/Resources/ProductoResource/Pages/ListProductos.php
  - app/Filament/Resources/ProductoResource/Pages/CreateProducto.php
  - app/Filament/Resources/ProductoResource/Pages/EditProducto.php
autonomous: true
requirements:
  - PROD-01
  - PROD-02
  - PROD-03
must_haves:
  truths:
    - "User can create a Producto with ClaveProdServ (searchable select), ClaveUnidad (searchable select), descripción, precio unitario (6 decimal places), and ObjetoImp"
    - "User can add tax lines to a product via Repeater: each line has Impuesto, TipoFactor, TasaOCuota, and es_retencion"
    - "User can apply a preset tax template (Solo IVA 16%, IVA 16% + ISR retención, Exento, IVA 0%) that populates the repeater"
    - "User can list, edit, soft-delete, restore, and force-delete Productos with TrashedFilter"
    - "Product list shows ClaveProdServ, description, unit price, and is searchable for Phase 4 consumption"
    - "Tax lines are persisted to producto_impuestos table via Repeater relationship"
  artifacts:
    - path: "app/Filament/Resources/ProductoResource.php"
      provides: "Full CRUD resource for Productos with tax repeater and template presets"
      contains: "Repeater"
    - path: "app/Filament/Resources/ProductoResource/Pages/ListProductos.php"
      provides: "List page for products"
      contains: "ListRecords"
    - path: "app/Filament/Resources/ProductoResource/Pages/CreateProducto.php"
      provides: "Create page for products"
      contains: "CreateRecord"
    - path: "app/Filament/Resources/ProductoResource/Pages/EditProducto.php"
      provides: "Edit page for products"
      contains: "EditRecord"
  key_links:
    - from: "app/Filament/Resources/ProductoResource.php"
      to: "app/Models/Producto.php"
      via: "Resource model binding"
      pattern: "protected static.*model.*Producto"
    - from: "app/Filament/Resources/ProductoResource.php"
      to: "app/Models/ProductoImpuesto.php"
      via: "Repeater relationship('impuestos')"
      pattern: "Repeater.*relationship.*impuestos"
    - from: "app/Filament/Resources/ProductoResource.php"
      to: "app/Models/ClaveProdServ.php"
      via: "Select options query"
      pattern: "ClaveProdServ"
    - from: "app/Filament/Resources/ProductoResource.php"
      to: "app/Models/TasaOCuota.php"
      via: "Dynamic select for tax rate within repeater"
      pattern: "TasaOCuota"
---

<objective>
Create the Filament UI for Producto management with tax line repeater and template presets.

Purpose: Users need a product/service catalog with pre-configured tax lines before creating invoices in Phase 4. The tax repeater is the most complex Filament component in this phase, requiring dynamic dependent selects (impuesto -> tasa_o_cuota filtering) and template preset buttons.
Output: 1 Filament resource (Producto) with 3 page classes, Repeater-managed tax lines, and template preset action — all following Filament 5 conventions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-emisor-receptores-y-productos/03-RESEARCH.md
@.planning/phases/03-emisor-receptores-y-productos/03-01-SUMMARY.md

<interfaces>
<!-- From 03-01-PLAN: Producto model -->

```php
final class Producto extends Model
{
    use SoftDeletes;
    protected $table = 'productos';
    protected $fillable = ['clave_prod_serv', 'clave_unidad', 'descripcion', 'precio_unitario', 'objeto_imp_clave'];

    protected function casts(): array
    {
        return ['precio_unitario' => 'decimal:6'];
    }

    public function claveProdServ(): BelongsTo { ... }  // FK: clave_prod_serv -> claves_prod_serv.clave
    public function claveUnidad(): BelongsTo { ... }     // FK: clave_unidad -> claves_unidad.clave
    public function objetoImp(): BelongsTo { ... }       // FK: objeto_imp_clave -> objetos_imp.clave
    public function impuestos(): HasMany { ... }         // -> producto_impuestos table
}
```

<!-- From 03-01-PLAN: ProductoImpuesto model -->

```php
final class ProductoImpuesto extends Model
{
    protected $table = 'producto_impuestos';
    protected $fillable = ['producto_id', 'impuesto_clave', 'tipo_factor', 'tasa_o_cuota_id', 'es_retencion'];

    protected function casts(): array
    {
        return ['es_retencion' => 'boolean'];
    }

    public function producto(): BelongsTo { ... }
    public function impuesto(): BelongsTo { ... }  // FK: impuesto_clave -> impuestos.clave
    public function tasaOCuota(): BelongsTo { ... } // FK: tasa_o_cuota_id -> tasas_o_cuotas.id
}
```

<!-- SAT catalog models for selects: -->

```php
// ClaveProdServ: ~53K rows, uses clave (string) PK, table: claves_prod_serv
// ClaveUnidad: ~2K rows, uses clave (string) PK, table: claves_unidad
// ObjetoImp: 3 rows, uses clave (string) PK, table: objetos_imp
// Impuesto: 3 rows (IVA, ISR, IEPS), uses clave (string) PK, table: impuestos
// TipoFactor: 3 rows (Tasa, Cuota, Exento), uses clave (string) PK
// TasaOCuota: ~20 rows, uses auto-increment id, table: tasas_o_cuotas
//   Fields: tipo, valor_minimo, valor_maximo, impuesto, factor, traslado, retencion
```

<!-- Established resource pattern (same as ReceptorResource from Plan 02): -->

```php
final class SomeResource extends Resource
{
    protected static ?string $model = Model::class;
    protected static string|BackedEnum|null $navigationIcon = '...';
    protected static string|UnitEnum|null $navigationGroup = 'Entidades';

    public static function form(Schema $schema): Schema { ... }
    public static function table(Table $table): Table
    {
        return $table
            ->columns([...])
            ->recordActions([
                EditAction::make(),
                DeleteAction::make()->label('Archivar'),
                RestoreAction::make(),
                ForceDeleteAction::make()->label('Eliminar permanentemente'),
            ])
            ->filters([TrashedFilter::make()]);
    }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProductoResource with form, tax repeater, and template presets</name>
  <files>
    app/Filament/Resources/ProductoResource.php
  </files>
  <action>
**Step 1: Create the Filament resource using Artisan.**

```bash
./vendor/bin/sail php artisan make:filament-resource Producto --no-interaction
```

**Step 2: Customize ProductoResource.php.**

The form has two sections: product details and tax configuration. The tax section uses a Repeater with `->relationship('impuestos')` that maps to the `producto_impuestos` child table via Producto's `impuestos()` HasMany.

The tax template presets are implemented as an `Action` on the Repeater's `hintAction()` — a button that opens a modal with a template select, then populates the repeater state.

```php
declare(strict_types=1);

namespace App\Filament\Resources;

use App\Filament\Resources\ProductoResource\Pages\CreateProducto;
use App\Filament\Resources\ProductoResource\Pages\EditProducto;
use App\Filament\Resources\ProductoResource\Pages\ListProductos;
use App\Models\ClaveProdServ;
use App\Models\ClaveUnidad;
use App\Models\Impuesto;
use App\Models\ObjetoImp;
use App\Models\Producto;
use App\Models\TasaOCuota;
use BackedEnum;
use Filament\Forms\Components\Actions\Action;
use Filament\Forms\Components\Repeater;
use Filament\Forms\Components\Section;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Components\Toggle;
use Filament\Forms\Get;
use Filament\Forms\Set;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Tables\Actions\DeleteAction;
use Filament\Tables\Actions\EditAction;
use Filament\Tables\Actions\ForceDeleteAction;
use Filament\Tables\Actions\RestoreAction;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Filters\TrashedFilter;
use Filament\Tables\Table;
use Override;
use UnitEnum;

final class ProductoResource extends Resource
{
    #[Override]
    protected static ?string $model = Producto::class;

    #[Override]
    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-cube';

    #[Override]
    protected static string|UnitEnum|null $navigationGroup = 'Entidades';

    #[Override]
    protected static ?string $modelLabel = 'Producto / Servicio';

    #[Override]
    protected static ?string $pluralModelLabel = 'Productos / Servicios';

    public static function form(Schema $schema): Schema
    {
        return $schema
            ->schema([
                Section::make('Datos del Producto')
                    ->schema([
                        Select::make('clave_prod_serv')
                            ->label('Clave Producto/Servicio SAT')
                            ->searchable()
                            ->getSearchResultsUsing(
                                fn (string $search): array => ClaveProdServ::query()
                                    ->where('clave', 'like', "%{$search}%")
                                    ->orWhere('descripcion', 'like', "%{$search}%")
                                    ->limit(50)
                                    ->pluck('descripcion', 'clave')
                                    ->map(fn (string $desc, string $clave): string => "{$clave} — {$desc}")
                                    ->all()
                            )
                            ->getOptionLabelUsing(
                                fn (?string $value): ?string => $value !== null
                                    ? ClaveProdServ::query()
                                        ->where('clave', $value)
                                        ->value('descripcion')
                                        ?->pipe(fn (string $desc): string => "{$value} — {$desc}")
                                    : null
                            )
                            ->required(),
                        Select::make('clave_unidad')
                            ->label('Clave Unidad SAT')
                            ->searchable()
                            ->getSearchResultsUsing(
                                fn (string $search): array => ClaveUnidad::query()
                                    ->where('clave', 'like', "%{$search}%")
                                    ->orWhere('nombre', 'like', "%{$search}%")
                                    ->limit(50)
                                    ->pluck('nombre', 'clave')
                                    ->map(fn (string $nombre, string $clave): string => "{$clave} — {$nombre}")
                                    ->all()
                            )
                            ->getOptionLabelUsing(
                                fn (?string $value): ?string => $value !== null
                                    ? ClaveUnidad::query()
                                        ->where('clave', $value)
                                        ->value('nombre')
                                        ?->pipe(fn (string $nombre): string => "{$value} — {$nombre}")
                                    : null
                            )
                            ->required(),
                        TextInput::make('descripcion')
                            ->label('Descripción')
                            ->required()
                            ->maxLength(1000),
                        TextInput::make('precio_unitario')
                            ->label('Precio Unitario')
                            ->required()
                            ->numeric()
                            ->step(0.000001)
                            ->minValue(0)
                            ->prefix('$'),
                        Select::make('objeto_imp_clave')
                            ->label('Objeto de Impuesto')
                            ->options(ObjetoImp::query()->pluck('descripcion', 'clave'))
                            ->required(),
                    ]),
                Section::make('Configuración de Impuestos')
                    ->schema([
                        Repeater::make('impuestos')
                            ->relationship('impuestos')
                            ->schema([
                                Select::make('impuesto_clave')
                                    ->label('Impuesto')
                                    ->options(Impuesto::query()->pluck('descripcion', 'clave'))
                                    ->required()
                                    ->live(),
                                Select::make('tipo_factor')
                                    ->label('Tipo Factor')
                                    ->options([
                                        'Tasa' => 'Tasa',
                                        'Cuota' => 'Cuota',
                                        'Exento' => 'Exento',
                                    ])
                                    ->required()
                                    ->live(),
                                Select::make('tasa_o_cuota_id')
                                    ->label('Tasa o Cuota')
                                    ->options(function (Get $get): array {
                                        $query = TasaOCuota::query();

                                        if ($get('impuesto_clave')) {
                                            $query->where('impuesto', $get('impuesto_clave'));
                                        }

                                        if ($get('tipo_factor')) {
                                            $query->where('factor', $get('tipo_factor'));
                                        }

                                        return $query->get()
                                            ->mapWithKeys(fn (TasaOCuota $t): array => [
                                                $t->id => $t->valor_maximo,
                                            ])
                                            ->all();
                                    })
                                    ->required(),
                                Toggle::make('es_retencion')
                                    ->label('¿Es retención?')
                                    ->default(false),
                            ])
                            ->defaultItems(0)
                            ->addActionLabel('Agregar impuesto')
                            ->columns(4)
                            ->hintAction(
                                Action::make('plantilla')
                                    ->label('Aplicar plantilla')
                                    ->icon('heroicon-o-document-duplicate')
                                    ->form([
                                        Select::make('template')
                                            ->label('Plantilla de impuestos')
                                            ->options([
                                                'iva16' => 'Solo IVA 16%',
                                                'iva16_isr10' => 'IVA 16% + ISR 10% retención',
                                                'exento' => 'Exento',
                                                'iva0' => 'IVA 0%',
                                            ])
                                            ->required(),
                                    ])
                                    ->action(function (array $data, Set $set): void {
                                        $set('impuestos', self::getTaxTemplate($data['template']));
                                    })
                            ),
                    ]),
            ]);
    }

    /**
     * Returns tax line arrays for preset templates.
     *
     * NOTE: tasa_o_cuota_id values reference tasas_o_cuotas.id auto-increment PKs.
     * These IDs depend on seeder order. The executor must verify the correct IDs
     * from the seeded data. The template uses placeholder values that will be
     * adjusted during implementation based on actual seeded TasaOCuota records.
     *
     * @return array<int, array<string, mixed>>
     */
    private static function getTaxTemplate(string $template): array
    {
        return match ($template) {
            'iva16' => [
                [
                    'impuesto_clave' => '002',
                    'tipo_factor' => 'Tasa',
                    'tasa_o_cuota_id' => TasaOCuota::query()
                        ->where('impuesto', '002')
                        ->where('factor', 'Tasa')
                        ->where('valor_maximo', '0.160000')
                        ->where('traslado', true)
                        ->value('id'),
                    'es_retencion' => false,
                ],
            ],
            'iva16_isr10' => [
                [
                    'impuesto_clave' => '002',
                    'tipo_factor' => 'Tasa',
                    'tasa_o_cuota_id' => TasaOCuota::query()
                        ->where('impuesto', '002')
                        ->where('factor', 'Tasa')
                        ->where('valor_maximo', '0.160000')
                        ->where('traslado', true)
                        ->value('id'),
                    'es_retencion' => false,
                ],
                [
                    'impuesto_clave' => '001',
                    'tipo_factor' => 'Tasa',
                    'tasa_o_cuota_id' => TasaOCuota::query()
                        ->where('impuesto', '001')
                        ->where('factor', 'Tasa')
                        ->where('valor_maximo', '0.100000')
                        ->where('retencion', true)
                        ->value('id'),
                    'es_retencion' => true,
                ],
            ],
            'exento' => [
                [
                    'impuesto_clave' => '002',
                    'tipo_factor' => 'Exento',
                    'tasa_o_cuota_id' => TasaOCuota::query()
                        ->where('impuesto', '002')
                        ->where('factor', 'Exento')
                        ->value('id'),
                    'es_retencion' => false,
                ],
            ],
            'iva0' => [
                [
                    'impuesto_clave' => '002',
                    'tipo_factor' => 'Tasa',
                    'tasa_o_cuota_id' => TasaOCuota::query()
                        ->where('impuesto', '002')
                        ->where('factor', 'Tasa')
                        ->where('valor_maximo', '0.000000')
                        ->where('traslado', true)
                        ->value('id'),
                    'es_retencion' => false,
                ],
            ],
            default => [],
        };
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                TextColumn::make('clave_prod_serv')
                    ->label('Clave SAT')
                    ->searchable()
                    ->sortable(),
                TextColumn::make('descripcion')
                    ->label('Descripción')
                    ->searchable()
                    ->sortable()
                    ->limit(60),
                TextColumn::make('claveUnidad.nombre')
                    ->label('Unidad')
                    ->limit(30),
                TextColumn::make('precio_unitario')
                    ->label('Precio Unitario')
                    ->money('MXN')
                    ->sortable(),
                TextColumn::make('objetoImp.descripcion')
                    ->label('Objeto Imp.')
                    ->limit(30)
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('impuestos_count')
                    ->label('Impuestos')
                    ->counts('impuestos')
                    ->badge(),
                TextColumn::make('created_at')
                    ->label('Fecha de registro')
                    ->date('d/m/Y')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->recordActions([
                EditAction::make(),
                DeleteAction::make()->label('Archivar'),
                RestoreAction::make(),
                ForceDeleteAction::make()->label('Eliminar permanentemente'),
            ])
            ->filters([
                TrashedFilter::make(),
            ])
            ->defaultSort('descripcion')
            ->paginated([10, 25, 50]);
    }

    public static function getPages(): array
    {
        return [
            'index' => ListProductos::route('/'),
            'create' => CreateProducto::route('/create'),
            'edit' => EditProducto::route('/{record}/edit'),
        ];
    }

    public static function getEloquentQuery(): \Illuminate\Database\Eloquent\Builder
    {
        return parent::getEloquentQuery()
            ->withoutGlobalScopes([
                \Illuminate\Database\Eloquent\SoftDeletingScope::class,
            ]);
    }
}
```

**Key implementation decisions:**
- ClaveProdServ select uses `getSearchResultsUsing()` (not `->options()`) because the table has ~53K rows — loading all as options would be unusable. Search queries are limited to 50 results and search both clave and descripcion.
- ClaveUnidad select also uses `getSearchResultsUsing()` for consistency, searching clave and nombre.
- Both selects use `getOptionLabelUsing()` for display of saved values on edit.
- The tax repeater uses `->relationship('impuestos')` which maps to Producto's `impuestos()` HasMany — Filament automatically creates/updates/deletes ProductoImpuesto records.
- TasaOCuota select is dynamically filtered by impuesto_clave and tipo_factor using `Get $get`. The `->live()` modifier on impuesto_clave and tipo_factor triggers re-evaluation.
- Tax templates query TasaOCuota at runtime to find the correct ID (not hardcoded) — this avoids the ID assumption pitfall (Pitfall 3 from research).
- The `precio_unitario` field uses `->step(0.000001)` for 6 decimal place precision per CFDI 4.0 requirements.

Run `vendor/bin/pint --dirty --format agent` after creating the file.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php -l app/Filament/Resources/ProductoResource.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>ProductoResource has form with searchable SAT catalog selects (ClaveProdServ, ClaveUnidad, ObjetoImp), price with 6 decimal step, tax Repeater with relationship('impuestos') and dynamic dependent selects, template preset action with 4 templates querying TasaOCuota at runtime, soft delete actions, TrashedFilter, and searchable table columns.</done>
</task>

<task type="auto">
  <name>Task 2: Create ProductoResource page classes</name>
  <files>
    app/Filament/Resources/ProductoResource/Pages/ListProductos.php
    app/Filament/Resources/ProductoResource/Pages/CreateProducto.php
    app/Filament/Resources/ProductoResource/Pages/EditProducto.php
  </files>
  <action>
The Artisan command from Task 1 may have generated stub pages. Customize each to follow the exact same pattern as ReceptorResource pages (from Plan 02).

**ListProductos.php:**

```php
declare(strict_types=1);

namespace App\Filament\Resources\ProductoResource\Pages;

use App\Filament\Resources\ProductoResource;
use Filament\Actions\CreateAction;
use Filament\Resources\Pages\ListRecords;
use Override;

final class ListProductos extends ListRecords
{
    #[Override]
    protected static string $resource = ProductoResource::class;

    protected function getHeaderActions(): array
    {
        return [
            CreateAction::make(),
        ];
    }
}
```

**CreateProducto.php:**

```php
declare(strict_types=1);

namespace App\Filament\Resources\ProductoResource\Pages;

use App\Filament\Resources\ProductoResource;
use Filament\Resources\Pages\CreateRecord;
use Override;

final class CreateProducto extends CreateRecord
{
    #[Override]
    protected static string $resource = ProductoResource::class;
}
```

**EditProducto.php:**

```php
declare(strict_types=1);

namespace App\Filament\Resources\ProductoResource\Pages;

use App\Filament\Resources\ProductoResource;
use Filament\Actions\DeleteAction;
use Filament\Resources\Pages\EditRecord;
use Override;

final class EditProducto extends EditRecord
{
    #[Override]
    protected static string $resource = ProductoResource::class;

    protected function getHeaderActions(): array
    {
        return [
            DeleteAction::make()->label('Archivar'),
        ];
    }
}
```

Run `vendor/bin/pint --dirty --format agent` after creating all files.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php -l app/Filament/Resources/ProductoResource/Pages/ListProductos.php && ./vendor/bin/sail php -l app/Filament/Resources/ProductoResource/Pages/CreateProducto.php && ./vendor/bin/sail php -l app/Filament/Resources/ProductoResource/Pages/EditProducto.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>ListProductos has CreateAction header, CreateProducto extends CreateRecord, EditProducto has Archivar delete action. All pages follow Filament 5 conventions with final class, declare(strict_types=1), and #[Override]. All pass Pint.</done>
</task>

</tasks>

<verification>
- ProductoResource list page loads with searchable columns
- Creating a product with ClaveProdServ search finds results
- ClaveUnidad search finds results
- Price field accepts 6 decimal places
- Tax repeater adds/removes tax lines
- Tax template presets populate the repeater with correct values
- TasaOCuota select filters by selected impuesto and tipo_factor
- Archiving (soft deleting) a product hides it from default list
- TrashedFilter shows archived products
- `vendor/bin/pint --dirty --format agent` reports no changes needed
- `./vendor/bin/sail php artisan test --compact` passes (no regressions)
</verification>

<success_criteria>
- ProductoResource with searchable ClaveProdServ/ClaveUnidad selects (limited to 50 results)
- Tax Repeater with relationship('impuestos') persisting to producto_impuestos table
- Dynamic TasaOCuota select filtered by impuesto_clave and tipo_factor
- 4 template presets querying TasaOCuota IDs at runtime
- Soft delete actions and TrashedFilter
- Searchable table with clave_prod_serv, descripcion, price, and impuestos count
</success_criteria>

<output>
After completion, create `.planning/phases/03-emisor-receptores-y-productos/03-03-SUMMARY.md`
</output>
