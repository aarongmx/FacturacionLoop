---
phase: 03-emisor-receptores-y-productos
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/2026_02_28_200000_create_emisores_table.php
  - database/migrations/2026_02_28_200001_create_emisor_regimen_fiscal_table.php
  - database/migrations/2026_02_28_200002_create_receptores_table.php
  - database/migrations/2026_02_28_200003_create_productos_table.php
  - database/migrations/2026_02_28_200004_create_producto_impuestos_table.php
  - app/Models/Emisor.php
  - app/Models/Receptor.php
  - app/Models/Producto.php
  - app/Models/ProductoImpuesto.php
  - app/Rules/ValidaRfc.php
  - database/factories/EmisorFactory.php
  - database/factories/ReceptorFactory.php
  - database/factories/ProductoFactory.php
  - database/factories/ProductoImpuestoFactory.php
autonomous: true
requirements:
  - ENT-01
  - ENT-03
  - ENT-04
  - PROD-01
  - PROD-03
must_haves:
  truths:
    - "emisores table exists with id, rfc, razon_social, domicilio_fiscal_cp, logo_path (nullable), timestamps"
    - "emisor_regimen_fiscal pivot table exists linking emisor_id to regimen_fiscal_clave"
    - "receptores table exists with id, rfc (indexed), nombre_fiscal, domicilio_fiscal_cp, regimen_fiscal_clave (FK), uso_cfdi_clave (FK), timestamps, softDeletes"
    - "productos table exists with id, clave_prod_serv (FK), clave_unidad (FK), descripcion, precio_unitario decimal(12,6), objeto_imp_clave (FK), timestamps, softDeletes"
    - "producto_impuestos child table exists with producto_id (FK), impuesto_clave (FK), tipo_factor, tasa_o_cuota_id (FK), es_retencion boolean, timestamps"
    - "Emisor model has regimenesFiscales() BelongsToMany relationship with all four key parameters specified"
    - "Receptor model has regimenFiscal() and usoCfdi() BelongsTo relationships with string FK to clave PK"
    - "Producto model has claveProdServ(), claveUnidad(), objetoImp() BelongsTo and impuestos() HasMany relationships"
    - "ValidaRfc rule accepts 12-char persona moral, 13-char persona fisica, XAXX010101000, XEXX010101000 and rejects invalid formats"
    - "All factories produce valid records for testing"
  artifacts:
    - path: "app/Models/Emisor.php"
      provides: "Singleton Emisor model with BelongsToMany regimenesFiscales"
      contains: "regimenesFiscales"
    - path: "app/Models/Receptor.php"
      provides: "Customer model with SoftDeletes and FK relationships to SAT catalogs"
      contains: "SoftDeletes"
    - path: "app/Models/Producto.php"
      provides: "Product model with SoftDeletes, FK relationships, and HasMany impuestos"
      contains: "impuestos"
    - path: "app/Models/ProductoImpuesto.php"
      provides: "Tax line child model linking producto to impuesto/tasa_o_cuota"
      contains: "BelongsTo"
    - path: "app/Rules/ValidaRfc.php"
      provides: "Reusable RFC format validation rule"
      contains: "ValidationRule"
    - path: "database/factories/ReceptorFactory.php"
      provides: "Factory with valid RFC generation and SAT catalog FK references"
      contains: "ReceptorFactory"
    - path: "database/factories/ProductoFactory.php"
      provides: "Factory with SAT catalog FK references"
      contains: "ProductoFactory"
  key_links:
    - from: "app/Models/Emisor.php"
      to: "app/Models/RegimenFiscal.php"
      via: "BelongsToMany pivot"
      pattern: "belongsToMany.*RegimenFiscal"
    - from: "app/Models/Receptor.php"
      to: "app/Models/RegimenFiscal.php"
      via: "BelongsTo FK"
      pattern: "belongsTo.*RegimenFiscal"
    - from: "app/Models/Producto.php"
      to: "app/Models/ProductoImpuesto.php"
      via: "HasMany relationship"
      pattern: "hasMany.*ProductoImpuesto"
    - from: "app/Models/ProductoImpuesto.php"
      to: "app/Models/TasaOCuota.php"
      via: "BelongsTo FK"
      pattern: "belongsTo.*TasaOCuota"
---

<objective>
Create the complete data layer foundation for Emisor, Receptor, and Producto entities.

Purpose: Every subsequent plan (Filament UI, tests) depends on these models, migrations, factories, and the ValidaRfc rule. This plan establishes all data contracts first so plans 02 and 03 can execute in parallel against stable models.
Output: 5 migrations, 4 models, 4 factories, 1 validation rule — all following existing project conventions from Phases 1 and 2.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-emisor-receptores-y-productos/03-RESEARCH.md

<interfaces>
<!-- Existing SAT catalog models that Phase 3 models reference via FK. All use string 'clave' as PK. -->

From app/Models/RegimenFiscal.php:
```php
final class RegimenFiscal extends Model
{
    protected $table = 'regimenes_fiscales';
    protected $primaryKey = 'clave';
    protected $keyType = 'string';
    // clave is string, e.g. '601', '612', '616'
}
```

From app/Models/UsoCfdi.php:
```php
final class UsoCfdi extends Model
{
    protected $table = 'usos_cfdi';
    protected $primaryKey = 'clave';
    protected $keyType = 'string';
    // clave is string, e.g. 'G01', 'G03', 'S01'
}
```

From app/Models/ClaveProdServ.php:
```php
final class ClaveProdServ extends Model
{
    protected $table = 'claves_prod_serv';
    protected $primaryKey = 'clave';
    protected $keyType = 'string';
    // clave is string, e.g. '01010101', '84111506'
}
```

From app/Models/ClaveUnidad.php:
```php
final class ClaveUnidad extends Model
{
    protected $table = 'claves_unidad';
    protected $primaryKey = 'clave';
    protected $keyType = 'string';
    // clave is string, e.g. 'E48', 'H87', 'ACT'
}
```

From app/Models/ObjetoImp.php:
```php
final class ObjetoImp extends Model
{
    protected $table = 'objetos_imp';
    protected $primaryKey = 'clave';
    protected $keyType = 'string';
    // clave is string, e.g. '01', '02', '03'
}
```

From app/Models/Impuesto.php:
```php
final class Impuesto extends Model
{
    protected $table = 'impuestos';
    protected $primaryKey = 'clave';
    protected $keyType = 'string';
    // clave is string, e.g. '001'=ISR, '002'=IVA, '003'=IEPS
}
```

From app/Models/TasaOCuota.php:
```php
final class TasaOCuota extends Model
{
    protected $table = 'tasas_o_cuotas';
    // Uses auto-increment id (no natural single-column PK)
    // Fields: tipo, valor_minimo, valor_maximo, impuesto, factor, traslado, retencion
}
```

<!-- Established model pattern from Phase 2 (Csd model): -->
```php
declare(strict_types=1);
namespace App\Models;

use Database\Factories\CsdFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Override;

final class Csd extends Model
{
    /** @use HasFactory<CsdFactory> */
    use HasFactory;
    use SoftDeletes;

    #[Override]
    protected $fillable = [...];

    protected function casts(): array { ... }
}
```

<!-- Established factory pattern from Phase 2 (CsdFactory): -->
```php
declare(strict_types=1);
namespace Database\Factories;

use App\Models\Csd;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<Csd> */
final class CsdFactory extends Factory
{
    public function definition(): array { ... }
    public function active(): static { ... }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrations for emisores, emisor_regimen_fiscal, receptores, productos, and producto_impuestos tables</name>
  <files>
    database/migrations/2026_02_28_200000_create_emisores_table.php
    database/migrations/2026_02_28_200001_create_emisor_regimen_fiscal_table.php
    database/migrations/2026_02_28_200002_create_receptores_table.php
    database/migrations/2026_02_28_200003_create_productos_table.php
    database/migrations/2026_02_28_200004_create_producto_impuestos_table.php
  </files>
  <action>
**Step 1: Create 5 migrations using Artisan.**

```bash
./vendor/bin/sail php artisan make:migration create_emisores_table --no-interaction
./vendor/bin/sail php artisan make:migration create_emisor_regimen_fiscal_table --no-interaction
./vendor/bin/sail php artisan make:migration create_receptores_table --no-interaction
./vendor/bin/sail php artisan make:migration create_productos_table --no-interaction
./vendor/bin/sail php artisan make:migration create_producto_impuestos_table --no-interaction
```

**Step 2: Customize each migration.** Rename them to use the `2026_02_28_200000` through `2026_02_28_200004` timestamps for consistent ordering after Phase 2 migrations.

**emisores table (singleton — id is always 1):**
```php
Schema::create('emisores', function (Blueprint $table): void {
    $table->id();
    $table->string('rfc', 13);
    $table->string('razon_social', 300);
    $table->string('domicilio_fiscal_cp', 5);
    $table->string('logo_path', 500)->nullable();
    $table->timestamps();
});
```

**emisor_regimen_fiscal pivot:**
```php
Schema::create('emisor_regimen_fiscal', function (Blueprint $table): void {
    $table->id();
    $table->foreignId('emisor_id')->constrained('emisores')->cascadeOnDelete();
    $table->string('regimen_fiscal_clave', 10);
    $table->foreign('regimen_fiscal_clave')->references('clave')->on('regimenes_fiscales');
    $table->unique(['emisor_id', 'regimen_fiscal_clave']);
});
```

**receptores table:**
```php
Schema::create('receptores', function (Blueprint $table): void {
    $table->id();
    $table->string('rfc', 13)->index();
    $table->string('nombre_fiscal', 300);
    $table->string('domicilio_fiscal_cp', 5);
    $table->string('regimen_fiscal_clave', 10)->nullable();
    $table->string('uso_cfdi_clave', 10)->nullable();
    $table->foreign('regimen_fiscal_clave')->references('clave')->on('regimenes_fiscales');
    $table->foreign('uso_cfdi_clave')->references('clave')->on('usos_cfdi');
    $table->timestamps();
    $table->softDeletes();
});
```

**productos table:**
```php
Schema::create('productos', function (Blueprint $table): void {
    $table->id();
    $table->string('clave_prod_serv', 10);
    $table->string('clave_unidad', 10);
    $table->string('descripcion', 1000);
    $table->decimal('precio_unitario', 12, 6);
    $table->string('objeto_imp_clave', 2);
    $table->foreign('clave_prod_serv')->references('clave')->on('claves_prod_serv');
    $table->foreign('clave_unidad')->references('clave')->on('claves_unidad');
    $table->foreign('objeto_imp_clave')->references('clave')->on('objetos_imp');
    $table->timestamps();
    $table->softDeletes();
});
```

**producto_impuestos child table:**
```php
Schema::create('producto_impuestos', function (Blueprint $table): void {
    $table->id();
    $table->foreignId('producto_id')->constrained('productos')->cascadeOnDelete();
    $table->string('impuesto_clave', 3);
    $table->string('tipo_factor', 10);
    $table->foreignId('tasa_o_cuota_id')->constrained('tasas_o_cuotas');
    $table->boolean('es_retencion')->default(false);
    $table->timestamps();
    $table->foreign('impuesto_clave')->references('clave')->on('impuestos');
});
```

**CRITICAL notes:**
- `regimen_fiscal_clave` and `uso_cfdi_clave` on receptores are nullable — new receptors can be created without selecting these initially
- `precio_unitario` uses `decimal(12,6)` — CFDI 4.0 requires 6 decimal places for ValorUnitario
- `producto_impuestos` uses cascadeOnDelete on producto_id — deleting a product deletes its tax lines
- All FK references use `->references('clave')->on(...)` because SAT catalog tables use string `clave` as PK
- receptores and productos have `softDeletes()` per locked decision

**Step 3: Run migrations.**
```bash
./vendor/bin/sail php artisan migrate --force
```

Run `vendor/bin/pint --dirty --format agent` after all PHP file changes.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php artisan migrate:status 2>&1 | grep -E "(emisores|emisor_regimen|receptores|productos|producto_impuestos)" && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>All 5 migrations ran successfully. Tables emisores, emisor_regimen_fiscal, receptores, productos, and producto_impuestos exist with correct columns, FKs, indexes, and softDeletes where applicable.</done>
</task>

<task type="auto">
  <name>Task 2: Create Emisor, Receptor, Producto, ProductoImpuesto models, ValidaRfc rule, and all factories</name>
  <files>
    app/Models/Emisor.php
    app/Models/Receptor.php
    app/Models/Producto.php
    app/Models/ProductoImpuesto.php
    app/Rules/ValidaRfc.php
    database/factories/EmisorFactory.php
    database/factories/ReceptorFactory.php
    database/factories/ProductoFactory.php
    database/factories/ProductoImpuestoFactory.php
  </files>
  <action>
**Step 1: Create models using Artisan.**

```bash
./vendor/bin/sail php artisan make:model Emisor --factory --no-interaction
./vendor/bin/sail php artisan make:model Receptor --factory --no-interaction
./vendor/bin/sail php artisan make:model Producto --factory --no-interaction
./vendor/bin/sail php artisan make:model ProductoImpuesto --factory --no-interaction
```

**Step 2: Create ValidaRfc rule.**

```bash
./vendor/bin/sail php artisan make:rule ValidaRfc --no-interaction
```

**Step 3: Customize Emisor model.**

The Emisor is a singleton — there is always exactly one row. It does NOT use SoftDeletes (you never delete the issuer).

```php
declare(strict_types=1);

namespace App\Models;

use Database\Factories\EmisorFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Override;

final class Emisor extends Model
{
    /** @use HasFactory<EmisorFactory> */
    use HasFactory;

    #[Override]
    protected $table = 'emisores';

    #[Override]
    protected $fillable = [
        'rfc',
        'razon_social',
        'domicilio_fiscal_cp',
        'logo_path',
    ];

    /** @return BelongsToMany<RegimenFiscal, $this> */
    public function regimenesFiscales(): BelongsToMany
    {
        return $this->belongsToMany(
            RegimenFiscal::class,
            'emisor_regimen_fiscal',
            'emisor_id',
            'regimen_fiscal_clave',
            'id',
            'clave',
        );
    }
}
```

**CRITICAL:** The `belongsToMany` MUST specify all four key parameters because `RegimenFiscal` uses string `clave` as its PK, not an integer id. Without explicit keys, Laravel will look for `regimen_fiscal_id` which does not exist (Pitfall 5 from research).

**Step 4: Customize Receptor model.**

```php
declare(strict_types=1);

namespace App\Models;

use Database\Factories\ReceptorFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\SoftDeletes;
use Override;

final class Receptor extends Model
{
    /** @use HasFactory<ReceptorFactory> */
    use HasFactory;
    use SoftDeletes;

    #[Override]
    protected $table = 'receptores';

    #[Override]
    protected $fillable = [
        'rfc',
        'nombre_fiscal',
        'domicilio_fiscal_cp',
        'regimen_fiscal_clave',
        'uso_cfdi_clave',
    ];

    /** @return BelongsTo<RegimenFiscal, $this> */
    public function regimenFiscal(): BelongsTo
    {
        return $this->belongsTo(RegimenFiscal::class, 'regimen_fiscal_clave', 'clave');
    }

    /** @return BelongsTo<UsoCfdi, $this> */
    public function usoCfdi(): BelongsTo
    {
        return $this->belongsTo(UsoCfdi::class, 'uso_cfdi_clave', 'clave');
    }
}
```

**Step 5: Customize Producto model.**

```php
declare(strict_types=1);

namespace App\Models;

use Database\Factories\ProductoFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\SoftDeletes;
use Override;

final class Producto extends Model
{
    /** @use HasFactory<ProductoFactory> */
    use HasFactory;
    use SoftDeletes;

    #[Override]
    protected $table = 'productos';

    #[Override]
    protected $fillable = [
        'clave_prod_serv',
        'clave_unidad',
        'descripcion',
        'precio_unitario',
        'objeto_imp_clave',
    ];

    /**
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'precio_unitario' => 'decimal:6',
        ];
    }

    /** @return BelongsTo<ClaveProdServ, $this> */
    public function claveProdServ(): BelongsTo
    {
        return $this->belongsTo(ClaveProdServ::class, 'clave_prod_serv', 'clave');
    }

    /** @return BelongsTo<ClaveUnidad, $this> */
    public function claveUnidad(): BelongsTo
    {
        return $this->belongsTo(ClaveUnidad::class, 'clave_unidad', 'clave');
    }

    /** @return BelongsTo<ObjetoImp, $this> */
    public function objetoImp(): BelongsTo
    {
        return $this->belongsTo(ObjetoImp::class, 'objeto_imp_clave', 'clave');
    }

    /** @return HasMany<ProductoImpuesto, $this> */
    public function impuestos(): HasMany
    {
        return $this->hasMany(ProductoImpuesto::class, 'producto_id');
    }
}
```

**CRITICAL:** The `impuestos()` HasMany relationship MUST exist on the model — the Filament Repeater in Plan 03 calls `->relationship('impuestos')` which looks up this Eloquent relation by name (Pitfall 1 from research).

**Step 6: Customize ProductoImpuesto model.**

```php
declare(strict_types=1);

namespace App\Models;

use Database\Factories\ProductoImpuestoFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Override;

final class ProductoImpuesto extends Model
{
    /** @use HasFactory<ProductoImpuestoFactory> */
    use HasFactory;

    #[Override]
    protected $table = 'producto_impuestos';

    #[Override]
    protected $fillable = [
        'producto_id',
        'impuesto_clave',
        'tipo_factor',
        'tasa_o_cuota_id',
        'es_retencion',
    ];

    /**
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'es_retencion' => 'boolean',
        ];
    }

    /** @return BelongsTo<Producto, $this> */
    public function producto(): BelongsTo
    {
        return $this->belongsTo(Producto::class);
    }

    /** @return BelongsTo<Impuesto, $this> */
    public function impuesto(): BelongsTo
    {
        return $this->belongsTo(Impuesto::class, 'impuesto_clave', 'clave');
    }

    /** @return BelongsTo<TasaOCuota, $this> */
    public function tasaOCuota(): BelongsTo
    {
        return $this->belongsTo(TasaOCuota::class);
    }
}
```

**Step 7: Customize ValidaRfc rule.**

```php
declare(strict_types=1);

namespace App\Rules;

use Closure;
use Illuminate\Contracts\Validation\ValidationRule;

final class ValidaRfc implements ValidationRule
{
    /** Persona moral: 3-letter company fragment + 6-digit date + 3-char homoclave = 12 chars */
    private const REGEX_MORAL = '/^[A-ZÑ&]{3}[0-9]{6}[A-Z0-9]{3}$/';

    /** Persona física: 4-letter surname fragment + 6-digit birth date + 3-char homoclave = 13 chars */
    private const REGEX_FISICA = '/^[A-ZÑ&]{4}[0-9]{6}[A-Z0-9]{3}$/';

    /** Generic RFCs that are always valid per SAT rules */
    private const GENERICOS = ['XAXX010101000', 'XEXX010101000'];

    public function validate(string $attribute, mixed $value, Closure $fail): void
    {
        $rfc = mb_strtoupper(trim((string) $value));

        if (in_array($rfc, self::GENERICOS, strict: true)) {
            return;
        }

        if (! preg_match(self::REGEX_MORAL, $rfc) && ! preg_match(self::REGEX_FISICA, $rfc)) {
            $fail('El RFC no tiene el formato válido del SAT (12 caracteres persona moral, 13 caracteres persona física).');
        }
    }
}
```

**Key notes:**
- Uses `mb_strtoupper()` (not `strtoupper()`) because RFC allows Ñ which is multi-byte
- Accepts & in RFC names (some companies have & in their legal name fragment)
- Normalizes input with `trim()` + uppercase before validation (Pitfall 2 from research)

**Step 8: Customize all factories.**

**EmisorFactory:**
```php
declare(strict_types=1);

namespace Database\Factories;

use App\Models\Emisor;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<Emisor> */
final class EmisorFactory extends Factory
{
    public function definition(): array
    {
        return [
            'rfc' => fake()->regexify('[A-Z]{4}[0-9]{6}[A-Z0-9]{3}'),
            'razon_social' => fake()->company(),
            'domicilio_fiscal_cp' => fake()->numerify('#####'),
            'logo_path' => null,
        ];
    }
}
```

**ReceptorFactory:**
```php
declare(strict_types=1);

namespace Database\Factories;

use App\Models\Receptor;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<Receptor> */
final class ReceptorFactory extends Factory
{
    public function definition(): array
    {
        return [
            'rfc' => fake()->regexify('[A-Z]{4}[0-9]{6}[A-Z0-9]{3}'),
            'nombre_fiscal' => fake()->company(),
            'domicilio_fiscal_cp' => fake()->numerify('#####'),
            'regimen_fiscal_clave' => null,
            'uso_cfdi_clave' => null,
        ];
    }

    /** Factory state for persona moral (12-char RFC). */
    public function personaMoral(): static
    {
        return $this->state(fn (array $attributes): array => [
            'rfc' => fake()->regexify('[A-Z]{3}[0-9]{6}[A-Z0-9]{3}'),
        ]);
    }

    /** Factory state for público en general. */
    public function publicoEnGeneral(): static
    {
        return $this->state(fn (array $attributes): array => [
            'rfc' => 'XAXX010101000',
            'nombre_fiscal' => 'PUBLICO EN GENERAL',
            'regimen_fiscal_clave' => '616',
            'uso_cfdi_clave' => 'S01',
        ]);
    }

    /** Factory state for extranjero. */
    public function extranjero(): static
    {
        return $this->state(fn (array $attributes): array => [
            'rfc' => 'XEXX010101000',
        ]);
    }
}
```

**ProductoFactory:**
```php
declare(strict_types=1);

namespace Database\Factories;

use App\Models\Producto;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<Producto> */
final class ProductoFactory extends Factory
{
    public function definition(): array
    {
        return [
            'clave_prod_serv' => '01010101',
            'clave_unidad' => 'E48',
            'descripcion' => fake()->sentence(4),
            'precio_unitario' => fake()->randomFloat(6, 1, 99999),
            'objeto_imp_clave' => '02',
        ];
    }
}
```

**CRITICAL note on ProductoFactory:** Uses hardcoded SAT catalog values ('01010101', 'E48', '02') as defaults. These are valid SAT claves that MUST exist in the seeded catalog tables. In tests, if the seeder has not run, the factory will need the SAT catalog factories to create referenced records first. The test plan (03-04) handles this by seeding required catalog records before creating Producto instances.

**ProductoImpuestoFactory:**
```php
declare(strict_types=1);

namespace Database\Factories;

use App\Models\ProductoImpuesto;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<ProductoImpuesto> */
final class ProductoImpuestoFactory extends Factory
{
    public function definition(): array
    {
        return [
            'producto_id' => \App\Models\Producto::factory(),
            'impuesto_clave' => '002',
            'tipo_factor' => 'Tasa',
            'tasa_o_cuota_id' => 1,
            'es_retencion' => false,
        ];
    }

    /** Factory state for IVA 16% traslado. */
    public function iva16(): static
    {
        return $this->state(fn (array $attributes): array => [
            'impuesto_clave' => '002',
            'tipo_factor' => 'Tasa',
            'es_retencion' => false,
        ]);
    }

    /** Factory state for ISR retencion. */
    public function isrRetencion(): static
    {
        return $this->state(fn (array $attributes): array => [
            'impuesto_clave' => '001',
            'tipo_factor' => 'Tasa',
            'es_retencion' => true,
        ]);
    }
}
```

Run `vendor/bin/pint --dirty --format agent` after creating all files.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php -l app/Models/Emisor.php && ./vendor/bin/sail php -l app/Models/Receptor.php && ./vendor/bin/sail php -l app/Models/Producto.php && ./vendor/bin/sail php -l app/Models/ProductoImpuesto.php && ./vendor/bin/sail php -l app/Rules/ValidaRfc.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -5</automated>
  </verify>
  <done>Emisor model has regimenesFiscales() BelongsToMany with all 4 key params. Receptor model has regimenFiscal() and usoCfdi() BelongsTo with string FK. Producto model has claveProdServ(), claveUnidad(), objetoImp() BelongsTo and impuestos() HasMany. ProductoImpuesto has producto(), impuesto(), tasaOCuota() BelongsTo. ValidaRfc accepts 12/13-char RFCs and generics, rejects invalid formats. All factories produce valid records. All files pass Pint.</done>
</task>

</tasks>

<verification>
- `./vendor/bin/sail php artisan migrate:status` shows all 5 new migrations as "Ran"
- `Emisor::factory()->create()` succeeds in tinker
- `Receptor::factory()->create()` succeeds in tinker
- `Producto::factory()->create()` succeeds in tinker (after seeding required SAT catalog records)
- `Emisor::first()->regimenesFiscales()` returns a BelongsToMany relation
- `Receptor::first()->regimenFiscal()` returns a BelongsTo relation
- `Producto::first()->impuestos()` returns a HasMany relation
- `vendor/bin/pint --dirty --format agent` reports no changes needed
- `./vendor/bin/sail php artisan test --compact` passes (no regressions)
</verification>

<success_criteria>
- 5 migrations creating emisores, emisor_regimen_fiscal, receptores, productos, producto_impuestos tables
- Emisor model with regimenesFiscales() BelongsToMany relationship using explicit 4-parameter key specification
- Receptor model with SoftDeletes, regimenFiscal() and usoCfdi() BelongsTo with string FK to clave PK
- Producto model with SoftDeletes, claveProdServ/claveUnidad/objetoImp BelongsTo and impuestos() HasMany
- ProductoImpuesto model with producto/impuesto/tasaOCuota BelongsTo relationships
- ValidaRfc rule accepting 12-char moral, 13-char fisica, XAXX/XEXX generics, rejecting invalid
- 4 factories with useful states (personaMoral, publicoEnGeneral, extranjero, iva16, isrRetencion)
</success_criteria>

<output>
After completion, create `.planning/phases/03-emisor-receptores-y-productos/03-01-SUMMARY.md`
</output>
