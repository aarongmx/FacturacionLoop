---
phase: 03-emisor-receptores-y-productos
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - app/Filament/Pages/EmisorSettings.php
  - resources/views/filament/pages/emisor-settings.blade.php
  - app/Filament/Resources/ReceptorResource.php
  - app/Filament/Resources/ReceptorResource/Pages/ListReceptores.php
  - app/Filament/Resources/ReceptorResource/Pages/CreateReceptor.php
  - app/Filament/Resources/ReceptorResource/Pages/EditReceptor.php
autonomous: true
requirements:
  - ENT-01
  - ENT-02
  - ENT-05
must_haves:
  truths:
    - "User can navigate to Emisor Settings page (top-level nav item, not nested) and save RFC, razón social, domicilio fiscal CP, and optional logo"
    - "User can select multiple fiscal regimes for the Emisor from a multi-select of seeded RegimenFiscal records, and the selection persists via the pivot table"
    - "User can create a Receptor with RFC, nombre fiscal, domicilio fiscal CP, régimen fiscal, and uso CFDI"
    - "RFC input auto-uppercases on the form and when XAXX010101000 is entered, nombre_fiscal, regimen_fiscal_clave, and uso_cfdi_clave auto-fill"
    - "User can list, edit, soft-delete (archive), restore, and force-delete Receptors with TrashedFilter"
    - "Receptor list is searchable by RFC and nombre_fiscal for Phase 4 search/select consumption"
  artifacts:
    - path: "app/Filament/Pages/EmisorSettings.php"
      provides: "Singleton settings page for Emisor data with multi-regime select"
      contains: "InteractsWithForms"
    - path: "resources/views/filament/pages/emisor-settings.blade.php"
      provides: "Blade template for Emisor settings form with save button"
      contains: "filament-panels::page"
    - path: "app/Filament/Resources/ReceptorResource.php"
      provides: "Full CRUD resource for Receptores with soft deletes"
      contains: "SoftDeletes"
    - path: "app/Filament/Resources/ReceptorResource/Pages/ListReceptores.php"
      provides: "List page for receptors"
      contains: "ListRecords"
    - path: "app/Filament/Resources/ReceptorResource/Pages/CreateReceptor.php"
      provides: "Create page for receptors"
      contains: "CreateRecord"
    - path: "app/Filament/Resources/ReceptorResource/Pages/EditReceptor.php"
      provides: "Edit page for receptors"
      contains: "EditRecord"
  key_links:
    - from: "app/Filament/Pages/EmisorSettings.php"
      to: "app/Models/Emisor.php"
      via: "firstOrCreate singleton pattern"
      pattern: "Emisor::firstOrCreate"
    - from: "app/Filament/Pages/EmisorSettings.php"
      to: "app/Models/RegimenFiscal.php"
      via: "Multi-select options for regimenesFiscales"
      pattern: "regimenesFiscales"
    - from: "app/Filament/Resources/ReceptorResource.php"
      to: "app/Models/Receptor.php"
      via: "Resource model binding"
      pattern: "protected static.*model.*Receptor"
    - from: "app/Filament/Resources/ReceptorResource.php"
      to: "app/Rules/ValidaRfc.php"
      via: "Form validation rule"
      pattern: "ValidaRfc"
---

<objective>
Create the Filament UI for Emisor settings (singleton form) and Receptor management (full CRUD with soft deletes).

Purpose: Users need to configure their issuer data and maintain a customer catalog before creating invoices in Phase 4. This plan delivers the Filament pages that make the Emisor and Receptor data from Plan 01 accessible to users.
Output: 1 Filament settings page (Emisor) with Blade template, 1 Filament resource (Receptor) with 3 page classes — all following Filament 5 conventions established in Phases 1 and 2.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-emisor-receptores-y-productos/03-RESEARCH.md
@.planning/phases/03-emisor-receptores-y-productos/03-01-SUMMARY.md

<interfaces>
<!-- From 03-01-PLAN: Emisor model -->

```php
final class Emisor extends Model
{
    protected $table = 'emisores';
    protected $fillable = ['rfc', 'razon_social', 'domicilio_fiscal_cp', 'logo_path'];

    public function regimenesFiscales(): BelongsToMany
    {
        return $this->belongsToMany(
            RegimenFiscal::class, 'emisor_regimen_fiscal',
            'emisor_id', 'regimen_fiscal_clave', 'id', 'clave',
        );
    }
}
```

<!-- From 03-01-PLAN: Receptor model -->

```php
final class Receptor extends Model
{
    use SoftDeletes;
    protected $table = 'receptores';
    protected $fillable = ['rfc', 'nombre_fiscal', 'domicilio_fiscal_cp', 'regimen_fiscal_clave', 'uso_cfdi_clave'];

    public function regimenFiscal(): BelongsTo { ... } // FK: regimen_fiscal_clave -> clave
    public function usoCfdi(): BelongsTo { ... }       // FK: uso_cfdi_clave -> clave
}
```

<!-- From 03-01-PLAN: ValidaRfc rule -->

```php
final class ValidaRfc implements ValidationRule
{
    public function validate(string $attribute, mixed $value, Closure $fail): void { ... }
    // Accepts: 12-char moral, 13-char fisica, XAXX010101000, XEXX010101000
}
```

<!-- Established Filament Resource pattern from CsdResource.php: -->

```php
final class CsdResource extends Resource
{
    #[Override]
    protected static ?string $model = Csd::class;

    #[Override]
    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-shield-check';

    #[Override]
    protected static string|UnitEnum|null $navigationGroup = 'Configuración';

    public static function form(Schema $schema): Schema { ... }
    public static function table(Table $table): Table
    {
        return $table
            ->columns([...])
            ->recordActions([
                ViewAction::make(),
                Action::make('activar')...,
                DeleteAction::make(),
            ]);
    }
}
```

<!-- Established Filament List page pattern from CsdResource/Pages/ListCsds.php: -->

```php
final class ListCsds extends ListRecords
{
    protected static string $resource = CsdResource::class;

    protected function getHeaderActions(): array
    {
        return [
            CreateAction::make(),
        ];
    }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Emisor Settings page with Blade template</name>
  <files>
    app/Filament/Pages/EmisorSettings.php
    resources/views/filament/pages/emisor-settings.blade.php
  </files>
  <action>
**Step 1: Create the Blade template directory and file.**

Create `resources/views/filament/pages/` directory if it does not exist. Then create `resources/views/filament/pages/emisor-settings.blade.php`:

```blade
<x-filament-panels::page>
    <x-filament::section>
        <x-slot name="heading">Datos Fiscales del Emisor</x-slot>

        {{ $this->form }}

        <div class="mt-6 flex justify-end">
            <x-filament::button wire:click="save" icon="heroicon-o-check">
                Guardar
            </x-filament::button>
        </div>
    </x-filament::section>
</x-filament-panels::page>
```

**Step 2: Create the EmisorSettings Filament page.**

Create `app/Filament/Pages/EmisorSettings.php`:

```php
declare(strict_types=1);

namespace App\Filament\Pages;

use App\Models\Emisor;
use App\Models\RegimenFiscal;
use Filament\Forms\Components\FileUpload;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Concerns\InteractsWithForms;
use Filament\Forms\Contracts\HasForms;
use Filament\Notifications\Notification;
use Filament\Pages\Page;
use Filament\Schemas\Schema;
use Override;

final class EmisorSettings extends Page implements HasForms
{
    use InteractsWithForms;

    #[Override]
    protected static string $view = 'filament.pages.emisor-settings';

    #[Override]
    protected static ?string $navigationIcon = 'heroicon-o-building-office';

    // Top-level nav item — NOT nested under a group (per locked decision)

    #[Override]
    protected static ?string $navigationLabel = 'Emisor';

    #[Override]
    protected static ?string $title = 'Configuración del Emisor';

    /** @var array<string, mixed> */
    public ?array $data = [];

    /** @var array<int, string> */
    public array $regimenes = [];

    public function mount(): void
    {
        $emisor = Emisor::firstOrCreate(
            ['id' => 1],
            [
                'rfc' => '',
                'razon_social' => '',
                'domicilio_fiscal_cp' => '',
            ],
        );

        $this->data = $emisor->only(['rfc', 'razon_social', 'domicilio_fiscal_cp', 'logo_path']);
        $this->regimenes = $emisor->regimenesFiscales()->pluck('clave')->all();
    }

    public function form(Schema $schema): Schema
    {
        return $schema
            ->schema([
                TextInput::make('rfc')
                    ->label('RFC del Emisor')
                    ->required()
                    ->maxLength(13)
                    ->minLength(12)
                    ->extraInputAttributes(['style' => 'text-transform: uppercase'])
                    ->dehydrateStateUsing(fn (?string $state): ?string => $state !== null ? mb_strtoupper(trim($state)) : null),
                TextInput::make('razon_social')
                    ->label('Razón Social')
                    ->required()
                    ->maxLength(300),
                TextInput::make('domicilio_fiscal_cp')
                    ->label('Código Postal del Domicilio Fiscal')
                    ->required()
                    ->maxLength(5)
                    ->minLength(5)
                    ->numeric(),
                Select::make('regimenes')
                    ->label('Regímenes Fiscales')
                    ->options(RegimenFiscal::query()->pluck('descripcion', 'clave'))
                    ->multiple()
                    ->required()
                    ->searchable()
                    ->statePath('regimenes'),
                FileUpload::make('logo_path')
                    ->label('Logo (opcional)')
                    ->image()
                    ->directory('emisor')
                    ->maxSize(2048)
                    ->nullable(),
            ])
            ->statePath('data');
    }

    public function save(): void
    {
        $state = $this->form->getState();

        $emisor = Emisor::firstOrCreate(['id' => 1]);
        $emisor->update([
            'rfc' => $state['rfc'],
            'razon_social' => $state['razon_social'],
            'domicilio_fiscal_cp' => $state['domicilio_fiscal_cp'],
            'logo_path' => $state['logo_path'] ?? null,
        ]);

        // Sync regimenes fiscales via the pivot table
        $emisor->regimenesFiscales()->sync($this->regimenes);

        Notification::make()
            ->title('Datos del emisor guardados')
            ->success()
            ->send();
    }
}
```

**Key decisions:**
- Uses `firstOrCreate(['id' => 1])` to ensure singleton pattern — no duplicate emisor records
- The regimenes Select uses `->options()` + separate `$regimenes` property instead of `->relationship()` because the BelongsToMany with string FK may not work correctly with Filament's auto-wiring (Open Question #1 from research). The `regimenes` state is managed separately and synced in `save()`.
- RFC input uses CSS `text-transform: uppercase` for visual uppercase + `dehydrateStateUsing` to store uppercase
- No `$navigationGroup` — top-level nav item per locked decision
- Logo uses FileUpload with `directory('emisor')` for organized storage

**IMPORTANT on regimenes multi-select:** Because RegimenFiscal uses `clave` (string) as PK, we cannot use Filament's `->relationship('regimenesFiscales', 'descripcion')` directly (Pitfall 6 from research). Instead, we load options manually and sync in `save()`. The `$regimenes` property holds the selected claves.

Run `vendor/bin/pint --dirty --format agent` after creating the file.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && test -f app/Filament/Pages/EmisorSettings.php && test -f resources/views/filament/pages/emisor-settings.blade.php && ./vendor/bin/sail php -l app/Filament/Pages/EmisorSettings.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>EmisorSettings page exists with Blade template, singleton pattern with firstOrCreate, multi-select for regimenes fiscales with manual sync, top-level navigation, RFC auto-uppercase, and FileUpload for logo.</done>
</task>

<task type="auto">
  <name>Task 2: Create ReceptorResource with CRUD pages and soft deletes</name>
  <files>
    app/Filament/Resources/ReceptorResource.php
    app/Filament/Resources/ReceptorResource/Pages/ListReceptores.php
    app/Filament/Resources/ReceptorResource/Pages/CreateReceptor.php
    app/Filament/Resources/ReceptorResource/Pages/EditReceptor.php
  </files>
  <action>
**Step 1: Create the Filament resource using Artisan.**

```bash
./vendor/bin/sail php artisan make:filament-resource Receptor --no-interaction
```

This generates the resource file and page stubs. Then customize each file.

**Step 2: Customize ReceptorResource.php.**

```php
declare(strict_types=1);

namespace App\Filament\Resources;

use App\Filament\Resources\ReceptorResource\Pages\CreateReceptor;
use App\Filament\Resources\ReceptorResource\Pages\EditReceptor;
use App\Filament\Resources\ReceptorResource\Pages\ListReceptores;
use App\Models\Receptor;
use App\Models\RegimenFiscal;
use App\Models\UsoCfdi;
use App\Rules\ValidaRfc;
use BackedEnum;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Get;
use Filament\Forms\Set;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Tables\Actions\DeleteAction;
use Filament\Tables\Actions\EditAction;
use Filament\Tables\Actions\ForceDeleteAction;
use Filament\Tables\Actions\RestoreAction;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Filters\TrashedFilter;
use Filament\Tables\Table;
use Override;
use UnitEnum;

final class ReceptorResource extends Resource
{
    #[Override]
    protected static ?string $model = Receptor::class;

    #[Override]
    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-users';

    #[Override]
    protected static string|UnitEnum|null $navigationGroup = 'Entidades';

    #[Override]
    protected static ?string $modelLabel = 'Receptor';

    #[Override]
    protected static ?string $pluralModelLabel = 'Receptores';

    public static function form(Schema $schema): Schema
    {
        return $schema
            ->schema([
                TextInput::make('rfc')
                    ->label('RFC')
                    ->required()
                    ->maxLength(13)
                    ->rules([new ValidaRfc])
                    ->extraInputAttributes(['style' => 'text-transform: uppercase'])
                    ->dehydrateStateUsing(fn (?string $state): ?string => $state !== null ? mb_strtoupper(trim($state)) : null)
                    ->live(onBlur: true)
                    ->afterStateUpdated(function (?string $state, Set $set): void {
                        if ($state === null) {
                            return;
                        }

                        $rfc = mb_strtoupper(trim($state));

                        // Auto-fill for público en general per locked decision
                        if ($rfc === 'XAXX010101000') {
                            $set('nombre_fiscal', 'PUBLICO EN GENERAL');
                            $set('regimen_fiscal_clave', '616');
                            $set('uso_cfdi_clave', 'S01');
                        }
                    }),
                TextInput::make('nombre_fiscal')
                    ->label('Nombre Fiscal / Razón Social')
                    ->required()
                    ->maxLength(300),
                TextInput::make('domicilio_fiscal_cp')
                    ->label('Código Postal del Domicilio Fiscal')
                    ->required()
                    ->maxLength(5)
                    ->minLength(5)
                    ->numeric(),
                Select::make('regimen_fiscal_clave')
                    ->label('Régimen Fiscal')
                    ->options(RegimenFiscal::query()->pluck('descripcion', 'clave'))
                    ->searchable()
                    ->nullable(),
                Select::make('uso_cfdi_clave')
                    ->label('Uso CFDI Predeterminado')
                    ->options(UsoCfdi::query()->pluck('descripcion', 'clave'))
                    ->searchable()
                    ->nullable(),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                TextColumn::make('rfc')
                    ->label('RFC')
                    ->searchable()
                    ->sortable(),
                TextColumn::make('nombre_fiscal')
                    ->label('Nombre Fiscal')
                    ->searchable()
                    ->sortable()
                    ->limit(50),
                TextColumn::make('domicilio_fiscal_cp')
                    ->label('CP')
                    ->sortable(),
                TextColumn::make('regimenFiscal.descripcion')
                    ->label('Régimen Fiscal')
                    ->limit(40)
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('usoCfdi.descripcion')
                    ->label('Uso CFDI')
                    ->limit(40)
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('created_at')
                    ->label('Fecha de registro')
                    ->date('d/m/Y')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->recordActions([
                EditAction::make(),
                DeleteAction::make()->label('Archivar'),
                RestoreAction::make(),
                ForceDeleteAction::make()->label('Eliminar permanentemente'),
            ])
            ->filters([
                TrashedFilter::make(),
            ])
            ->defaultSort('nombre_fiscal')
            ->paginated([10, 25, 50]);
    }

    public static function getPages(): array
    {
        return [
            'index' => ListReceptores::route('/'),
            'create' => CreateReceptor::route('/create'),
            'edit' => EditReceptor::route('/{record}/edit'),
        ];
    }

    public static function getEloquentQuery(): \Illuminate\Database\Eloquent\Builder
    {
        return parent::getEloquentQuery()
            ->withoutGlobalScopes([
                \Illuminate\Database\Eloquent\SoftDeletingScope::class,
            ]);
    }
}
```

**Key implementation notes:**
- RFC field uses `ValidaRfc` rule, auto-uppercase via CSS + dehydrateStateUsing, and `->live(onBlur: true)` for auto-fill trigger
- Auto-fill for XAXX010101000: sets nombre_fiscal, regimen_fiscal_clave, uso_cfdi_clave per locked decision
- Soft delete actions: "Archivar" (delete), "Restore", "Eliminar permanentemente" (force delete) per locked decision
- `getEloquentQuery()` removes `SoftDeletingScope` so the TrashedFilter can show all records including archived
- Select fields for regimen_fiscal_clave and uso_cfdi_clave use `->options()` with searchable (not `->relationship()`) because SAT catalog models use string `clave` as PK
- `navigationGroup` is 'Entidades' — groups Receptor and Producto resources together

**Step 3: Customize ListReceptores page.**

```php
declare(strict_types=1);

namespace App\Filament\Resources\ReceptorResource\Pages;

use App\Filament\Resources\ReceptorResource;
use Filament\Actions\CreateAction;
use Filament\Resources\Pages\ListRecords;
use Override;

final class ListReceptores extends ListRecords
{
    #[Override]
    protected static string $resource = ReceptorResource::class;

    protected function getHeaderActions(): array
    {
        return [
            CreateAction::make(),
        ];
    }
}
```

**Step 4: Customize CreateReceptor page.**

```php
declare(strict_types=1);

namespace App\Filament\Resources\ReceptorResource\Pages;

use App\Filament\Resources\ReceptorResource;
use Filament\Resources\Pages\CreateRecord;
use Override;

final class CreateReceptor extends CreateRecord
{
    #[Override]
    protected static string $resource = ReceptorResource::class;
}
```

**Step 5: Customize EditReceptor page.**

```php
declare(strict_types=1);

namespace App\Filament\Resources\ReceptorResource\Pages;

use App\Filament\Resources\ReceptorResource;
use Filament\Actions\DeleteAction;
use Filament\Resources\Pages\EditRecord;
use Override;

final class EditReceptor extends EditRecord
{
    #[Override]
    protected static string $resource = ReceptorResource::class;

    protected function getHeaderActions(): array
    {
        return [
            DeleteAction::make()->label('Archivar'),
        ];
    }
}
```

Run `vendor/bin/pint --dirty --format agent` after creating all files.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php -l app/Filament/Resources/ReceptorResource.php && ./vendor/bin/sail php -l app/Filament/Resources/ReceptorResource/Pages/ListReceptores.php && ./vendor/bin/sail php -l app/Filament/Resources/ReceptorResource/Pages/CreateReceptor.php && ./vendor/bin/sail php -l app/Filament/Resources/ReceptorResource/Pages/EditReceptor.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>ReceptorResource has form with ValidaRfc, auto-uppercase RFC, XAXX010101000 auto-fill, SAT catalog selects. Table has searchable RFC/nombre_fiscal, soft delete actions (Archivar/Restore/ForceDelete), TrashedFilter. List/Create/Edit pages follow Filament 5 conventions. All files pass Pint.</done>
</task>

</tasks>

<verification>
- EmisorSettings page loads without errors in Filament
- Emisor form saves RFC, razón social, CP, and regímenes fiscales
- ReceptorResource list page loads with searchable columns
- Creating a receptor with valid RFC succeeds
- Creating a receptor with invalid RFC shows validation error
- Entering XAXX010101000 auto-fills nombre, régimen, and uso CFDI
- Archiving (soft deleting) a receptor hides it from default list
- TrashedFilter shows archived receptors
- Restoring an archived receptor makes it visible again
- `vendor/bin/pint --dirty --format agent` reports no changes needed
- `./vendor/bin/sail php artisan test --compact` passes (no regressions)
</verification>

<success_criteria>
- EmisorSettings singleton page with multi-regime select, top-level navigation, and logo upload
- ReceptorResource with full CRUD, ValidaRfc validation, XAXX auto-fill, soft deletes, and TrashedFilter
- All files follow Filament 5 conventions (Schema, string|BackedEnum|null, recordActions)
- RFC auto-uppercase on both Emisor and Receptor forms
</success_criteria>

<output>
After completion, create `.planning/phases/03-emisor-receptores-y-productos/03-02-SUMMARY.md`
</output>
