---
phase: 01-cat-logos-sat-base
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/2026_02_27_200000_create_regimenes_fiscales_table.php
  - database/migrations/2026_02_27_200001_create_usos_cfdi_table.php
  - database/migrations/2026_02_27_200002_create_formas_pago_table.php
  - database/migrations/2026_02_27_200003_create_metodos_pago_table.php
  - database/migrations/2026_02_27_200004_create_tipos_comprobante_table.php
  - database/migrations/2026_02_27_200005_create_impuestos_table.php
  - database/migrations/2026_02_27_200006_create_tipos_factor_table.php
  - database/migrations/2026_02_27_200007_create_objetos_imp_table.php
  - database/migrations/2026_02_27_200008_create_tipos_relacion_table.php
  - database/migrations/2026_02_27_200009_create_claves_prod_serv_table.php
  - database/migrations/2026_02_27_200010_create_claves_unidad_table.php
  - database/migrations/2026_02_27_200011_create_tasas_o_cuotas_table.php
  - app/Models/RegimenFiscal.php
  - app/Models/UsoCfdi.php
  - app/Models/FormaPago.php
  - app/Models/MetodoPago.php
  - app/Models/TipoDeComprobante.php
  - app/Models/Impuesto.php
  - app/Models/TipoFactor.php
  - app/Models/ObjetoImp.php
  - app/Models/TipoRelacion.php
  - app/Models/ClaveProdServ.php
  - app/Models/ClaveUnidad.php
  - app/Models/TasaOCuota.php
  - database/factories/RegimenFiscalFactory.php
  - database/factories/UsoCfdiFactory.php
  - database/factories/FormaPagoFactory.php
  - database/factories/MetodoPagoFactory.php
  - database/factories/TipoDeComprobanteFactory.php
  - database/factories/ImpuestoFactory.php
  - database/factories/TipoFactorFactory.php
  - database/factories/ObjetoImpFactory.php
  - database/factories/TipoRelacionFactory.php
  - database/factories/ClaveProdServFactory.php
  - database/factories/ClaveUnidadFactory.php
  - database/factories/TasaOCuotaFactory.php
autonomous: true
requirements:
  - CAT-01
  - CAT-02
  - CAT-03
  - CAT-04
  - CAT-05
  - CAT-06
  - CAT-07
  - CAT-08
  - CAT-09
  - CAT-10
  - CAT-11
  - CAT-12
must_haves:
  truths:
    - "All 12 SAT catalog tables exist in the database after running migrations"
    - "Each catalog model uses a string primary key (clave) matching the SAT catalog key — except TasaOCuota which uses auto-increment id"
    - "Each model has a factory that produces valid records for testing"
    - "Large catalogs (claves_prod_serv, claves_unidad) have database indexes on searchable columns"
  artifacts:
    - path: "app/Models/RegimenFiscal.php"
      provides: "Eloquent model for c_RegimenFiscal catalog"
      contains: "primaryKey = 'clave'"
    - path: "app/Models/ClaveProdServ.php"
      provides: "Eloquent model for c_ClaveProdServ catalog (~53K rows)"
      contains: "primaryKey = 'clave'"
    - path: "app/Models/ClaveUnidad.php"
      provides: "Eloquent model for c_ClaveUnidad catalog (~2K rows)"
      contains: "primaryKey = 'clave'"
    - path: "app/Models/TasaOCuota.php"
      provides: "Eloquent model for c_TasaOCuota (composite key catalog)"
      contains: "class TasaOCuota"
    - path: "database/migrations/2026_02_27_200009_create_claves_prod_serv_table.php"
      provides: "Migration with index on descripcion for search performance"
      contains: "index('descripcion')"
  key_links:
    - from: "app/Models/RegimenFiscal.php"
      to: "database/migrations/*_create_regimenes_fiscales_table.php"
      via: "Eloquent convention"
      pattern: "regimenes_fiscales"
    - from: "app/Models/TasaOCuota.php"
      to: "app/Models/Impuesto.php"
      via: "BelongsTo relationship"
      pattern: "belongsTo.*Impuesto"
---

<objective>
Create all 12 SAT catalog database tables, Eloquent models, and test factories.

Purpose: These models and migrations form the data foundation for every CFDI form dropdown in subsequent phases. Without them, no invoice form can be built.
Output: 12 migrations, 12 models, 12 factories — all following existing project conventions (string PK, `$incrementing = false`, `HasFactory` trait).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cat-logos-sat-base/01-RESEARCH.md

<interfaces>
<!-- Existing model pattern to follow exactly. From app/Models/CustomUnit.php: -->

```php
<?php
declare(strict_types=1);
namespace App\Models;

use Database\Factories\CustomUnitFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Override;

final class CustomUnit extends Model
{
    /** @use HasFactory<CustomUnitFactory> */
    use HasFactory;

    #[Override]
    public $incrementing = false;

    #[Override]
    protected $primaryKey = 'code';

    #[Override]
    protected $keyType = 'string';

    #[Override]
    protected $fillable = ['code', 'name'];
}
```

<!-- Existing factory pattern to follow. From database/factories/CustomUnitFactory.php: -->

```php
<?php
declare(strict_types=1);
namespace Database\Factories;

use App\Models\CustomUnit;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<CustomUnit> */
final class CustomUnitFactory extends Factory
{
    public function definition(): array
    {
        return [
            'code' => fake()->regexify('[A-Z]{3}'),
            'name' => fake()->word(),
        ];
    }
}
```

<!-- Existing migration pattern. From database/migrations/2026_02_27_080200_create_custom_units_table.php: -->

```php
<?php
declare(strict_types=1);
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('custom_units', function (Blueprint $table): void {
            $table->string('code', 3)->primary();
            $table->string('name');
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('custom_units');
    }
};
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrations, models, and factories for 9 small SAT catalogs</name>
  <files>
    database/migrations/2026_02_27_200000_create_regimenes_fiscales_table.php
    database/migrations/2026_02_27_200001_create_usos_cfdi_table.php
    database/migrations/2026_02_27_200002_create_formas_pago_table.php
    database/migrations/2026_02_27_200003_create_metodos_pago_table.php
    database/migrations/2026_02_27_200004_create_tipos_comprobante_table.php
    database/migrations/2026_02_27_200005_create_impuestos_table.php
    database/migrations/2026_02_27_200006_create_tipos_factor_table.php
    database/migrations/2026_02_27_200007_create_objetos_imp_table.php
    database/migrations/2026_02_27_200008_create_tipos_relacion_table.php
    app/Models/RegimenFiscal.php
    app/Models/UsoCfdi.php
    app/Models/FormaPago.php
    app/Models/MetodoPago.php
    app/Models/TipoDeComprobante.php
    app/Models/Impuesto.php
    app/Models/TipoFactor.php
    app/Models/ObjetoImp.php
    app/Models/TipoRelacion.php
    database/factories/RegimenFiscalFactory.php
    database/factories/UsoCfdiFactory.php
    database/factories/FormaPagoFactory.php
    database/factories/MetodoPagoFactory.php
    database/factories/TipoDeComprobanteFactory.php
    database/factories/ImpuestoFactory.php
    database/factories/TipoFactorFactory.php
    database/factories/ObjetoImpFactory.php
    database/factories/TipoRelacionFactory.php
  </files>
  <action>
Create 9 small SAT catalog tables with their Eloquent models and factories. Use `php artisan make:model` with `--migration --factory` flags, then customize. All models follow the exact CustomUnit pattern: `final class`, `HasFactory` trait, `$incrementing = false`, string `$primaryKey = 'clave'`, `$keyType = 'string'`, `#[Override]` attribute on overridden properties, `declare(strict_types=1)`.

**Table naming:** Use descriptive Spanish plurals (not `c_` prefix):
- `regimenes_fiscales`, `usos_cfdi`, `formas_pago`, `metodos_pago`, `tipos_comprobante`, `impuestos`, `tipos_factor`, `objetos_imp`, `tipos_relacion`

**Schema per catalog (all use string PK via `$table->string('clave', 10)->primary()`):**

1. **regimenes_fiscales** (CAT-01): `clave` PK, `descripcion` string, `aplica_fisica` boolean default false, `aplica_moral` boolean default false, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
2. **usos_cfdi** (CAT-02): `clave` PK, `descripcion` string, `aplica_fisica` boolean default false, `aplica_moral` boolean default false, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
3. **formas_pago** (CAT-03): `clave` PK, `descripcion` string, `bancarizado` boolean default false, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
4. **metodos_pago** (CAT-04): `clave` PK, `descripcion` string, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
5. **tipos_comprobante** (CAT-05): `clave` PK (string, 5), `descripcion` string, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
6. **impuestos** (CAT-08): `clave` PK (string, 5), `descripcion` string, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
7. **tipos_factor** (CAT-09): `clave` PK (string, 10), `descripcion` string, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps — note: clave values are "Tasa", "Cuota", "Exento"
8. **objetos_imp** (CAT-11): `clave` PK (string, 5), `descripcion` string, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps
9. **tipos_relacion** (CAT-12): `clave` PK (string, 5), `descripcion` string, `vigencia_inicio` date nullable, `vigencia_fin` date nullable, timestamps

**Model casts (use `casts()` method, not `$casts` property):**
- Booleans: `'aplica_fisica' => 'boolean'`, `'aplica_moral' => 'boolean'`, `'bancarizado' => 'boolean'`
- Dates: `'vigencia_inicio' => 'date'`, `'vigencia_fin' => 'date'`

**Factories:**
- `clave`: `fake()->unique()->regexify('[0-9]{3}')` (numeric code format)
- `descripcion`: `fake()->sentence(3)`
- Booleans: `fake()->boolean()`
- Dates: null by default

After creating all files, set the migration timestamps to ensure ordering (all later than existing 2026_02_27_083423 migration). Use timestamps 200000 through 200008.

Run `vendor/bin/pint --dirty --format agent` after creating all PHP files.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && php artisan migrate --force 2>&1 | grep -c "create_" && php artisan test --compact --filter=ExampleTest 2>&1 | tail -5</automated>
  </verify>
  <done>9 migration files exist and run without error. 9 model files follow existing CustomUnit pattern with string PK. 9 factory files produce valid test data. All PHP files pass Pint formatting.</done>
</task>

<task type="auto">
  <name>Task 2: Create migrations, models, and factories for 3 large/special SAT catalogs</name>
  <files>
    database/migrations/2026_02_27_200009_create_claves_prod_serv_table.php
    database/migrations/2026_02_27_200010_create_claves_unidad_table.php
    database/migrations/2026_02_27_200011_create_tasas_o_cuotas_table.php
    app/Models/ClaveProdServ.php
    app/Models/ClaveUnidad.php
    app/Models/TasaOCuota.php
    database/factories/ClaveProdServFactory.php
    database/factories/ClaveUnidadFactory.php
    database/factories/TasaOCuotaFactory.php
  </files>
  <action>
Create 3 catalogs that need special handling: two large catalogs with search indexes and one composite-key catalog.

**1. claves_prod_serv (CAT-06 — ~53,000 rows):**

Migration:
```php
$table->string('clave', 20)->primary();
$table->string('descripcion');
$table->string('incluye_iva', 20)->nullable();
$table->string('incluye_ieps', 20)->nullable();
$table->string('complemento', 100)->nullable();
$table->date('vigencia_inicio')->nullable();
$table->date('vigencia_fin')->nullable();
$table->boolean('estimulo_franja')->default(false);
$table->text('palabras_similares')->nullable();
$table->timestamps();
$table->index('descripcion'); // CRITICAL for Filament search performance
```

Model: `ClaveProdServ` — string PK `clave`, `$incrementing = false`, `$keyType = 'string'`. Same pattern as other models. Cast `estimulo_franja` to boolean, dates to date.

Factory: `clave` as `fake()->unique()->numerify('########')`, `descripcion` as `fake()->sentence(4)`.

**2. claves_unidad (CAT-07 — ~2,000 rows):**

Migration:
```php
$table->string('clave', 10)->primary();
$table->string('nombre');
$table->string('descripcion')->nullable();
$table->text('nota')->nullable();
$table->date('vigencia_inicio')->nullable();
$table->date('vigencia_fin')->nullable();
$table->string('simbolo', 20)->nullable();
$table->timestamps();
$table->index('nombre'); // For search performance
```

Model: `ClaveUnidad` — string PK `clave`, `$incrementing = false`, `$keyType = 'string'`. Cast dates to date.

Factory: `clave` as `fake()->unique()->regexify('[A-Z][A-Z0-9]{2}')`, `nombre` as `fake()->word()`.

**3. tasas_o_cuotas (CAT-10 — ~20 rows, NO natural single-column PK):**

This is the SPECIAL CASE. Do NOT use string PK. Use auto-increment id with a composite unique index.

Migration:
```php
$table->id(); // auto-increment integer PK
$table->string('tipo', 10)->nullable(); // 'Fijo' or 'Rango'
$table->string('valor_minimo', 20);
$table->string('valor_maximo', 20);
$table->string('impuesto', 5); // FK-like: '001' (ISR), '002' (IVA), '003' (IEPS)
$table->string('factor', 10); // 'Tasa', 'Cuota'
$table->boolean('traslado')->default(false);
$table->boolean('retencion')->default(false);
$table->date('vigencia_inicio')->nullable();
$table->date('vigencia_fin')->nullable();
$table->timestamps();
$table->unique(['impuesto', 'factor', 'valor_minimo', 'valor_maximo', 'traslado', 'retencion'], 'tasas_o_cuotas_composite_unique');
```

Model: `TasaOCuota` — uses standard auto-increment id (do NOT set `$incrementing = false`). DO add `$table` override to `'tasas_o_cuotas'`. Add a `belongsTo` relationship to `Impuesto` model: `$this->belongsTo(Impuesto::class, 'impuesto', 'clave')`. Cast booleans and dates.

Factory: `impuesto` as `fake()->randomElement(['001', '002', '003'])`, `factor` as `fake()->randomElement(['Tasa', 'Cuota'])`, `valor_minimo` and `valor_maximo` as `'0.160000'`, `traslado` and `retencion` as `fake()->boolean()`.

Run `php artisan migrate --force` to verify all migrations run. Run `vendor/bin/pint --dirty --format agent` to fix formatting.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && php artisan migrate:status 2>&1 | grep -c "Ran" && php artisan tinker --execute="echo App\Models\ClaveProdServ::query()->getQuery()->getConnection()->getSchemaBuilder()->hasTable('claves_prod_serv') ? 'OK' : 'FAIL';"</automated>
  </verify>
  <done>3 migration files exist and run. claves_prod_serv and claves_unidad tables have search indexes on descripcion/nombre respectively. tasas_o_cuotas uses auto-increment id with composite unique index. TasaOCuota model has belongsTo relationship to Impuesto. All PHP files pass Pint.</done>
</task>

</tasks>

<verification>
- `php artisan migrate:status` shows all 12 new migrations as "Ran"
- All 12 model files exist in `app/Models/` and follow the existing project pattern
- All 12 factory files exist in `database/factories/`
- `vendor/bin/pint --dirty --format agent` reports no changes needed
- `php artisan test --compact` passes (no regressions)
</verification>

<success_criteria>
- 12 database tables created matching SAT catalog schemas
- 12 Eloquent models with correct PK configuration (11 string PKs + 1 auto-increment)
- 12 factories producing valid test data
- Database indexes on `claves_prod_serv.descripcion` and `claves_unidad.nombre`
- TasaOCuota model has composite unique constraint and Impuesto relationship
</success_criteria>

<output>
After completion, create `.planning/phases/01-cat-logos-sat-base/01-01-SUMMARY.md`
</output>
