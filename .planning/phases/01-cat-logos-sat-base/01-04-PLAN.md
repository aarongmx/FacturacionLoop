---
phase: 01-cat-logos-sat-base
plan: 04
type: execute
wave: 3
depends_on:
  - 01-01
  - 01-02
files_modified:
  - tests/Feature/Models/RegimenFiscalTest.php
  - tests/Feature/Models/UsoCfdiTest.php
  - tests/Feature/Models/FormaPagoTest.php
  - tests/Feature/Models/MetodoPagoTest.php
  - tests/Feature/Models/TipoDeComprobanteTest.php
  - tests/Feature/Models/ImpuestoTest.php
  - tests/Feature/Models/TipoFactorTest.php
  - tests/Feature/Models/ObjetoImpTest.php
  - tests/Feature/Models/TipoRelacionTest.php
  - tests/Feature/Models/ClaveProdServTest.php
  - tests/Feature/Models/ClaveUnidadTest.php
  - tests/Feature/Models/TasaOCuotaTest.php
autonomous: true
requirements:
  - CAT-01
  - CAT-02
  - CAT-03
  - CAT-04
  - CAT-05
  - CAT-06
  - CAT-07
  - CAT-08
  - CAT-09
  - CAT-10
  - CAT-11
  - CAT-12
must_haves:
  truths:
    - "All 12 SAT catalog model tests pass with php artisan test --compact"
    - "Each model can be created via its factory and persisted to the database"
    - "ClaveProdServ can be searched by descripcion and the correct record is returned"
    - "ClaveUnidad can be searched by nombre and the correct record is returned"
    - "TasaOCuota has a working belongsTo relationship to Impuesto"
  artifacts:
    - path: "tests/Feature/Models/RegimenFiscalTest.php"
      provides: "Feature test for RegimenFiscal model creation and properties"
      contains: "it('can be created"
    - path: "tests/Feature/Models/ClaveProdServTest.php"
      provides: "Feature test for ClaveProdServ including search behavior"
      contains: "it('can be searched"
    - path: "tests/Feature/Models/TasaOCuotaTest.php"
      provides: "Feature test for TasaOCuota including Impuesto relationship"
      contains: "belongsTo"
  key_links:
    - from: "tests/Feature/Models/RegimenFiscalTest.php"
      to: "app/Models/RegimenFiscal.php"
      via: "Factory::create() and model assertions"
      pattern: "RegimenFiscal::factory"
    - from: "tests/Feature/Models/TasaOCuotaTest.php"
      to: "app/Models/Impuesto.php"
      via: "Relationship test via factory"
      pattern: "impuesto"
---

<objective>
Create comprehensive feature tests for all 12 SAT catalog models verifying creation, properties, relationships, and search behavior.

Purpose: Tests prove that models, factories, and migrations work correctly. They also serve as regression protection for future phases that depend on these catalogs. The Pest testing skill applies.
Output: 12 Pest feature test files covering model creation, string PK behavior, casts, relationships, and large-catalog search.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cat-logos-sat-base/01-RESEARCH.md
@.planning/phases/01-cat-logos-sat-base/01-01-SUMMARY.md
@.planning/phases/01-cat-logos-sat-base/01-02-SUMMARY.md

<interfaces>
<!-- Existing test patterns: tests/Feature/Models/ directory already has CustomUnitTest.php and TariffClassificationTest.php (both empty stubs with just declare(strict_types=1)). -->
<!-- Use Pest 4 syntax. Create tests with: php artisan make:test --pest Feature/Models/{ModelName}Test -->

<!-- Expected test structure for a small catalog model: -->
```php
<?php
declare(strict_types=1);

use App\Models\RegimenFiscal;

it('can be created via factory', function (): void {
    $record = RegimenFiscal::factory()->create();
    expect($record)->toBeInstanceOf(RegimenFiscal::class)
        ->and($record->clave)->toBeString();
});

it('uses string primary key', function (): void {
    $record = RegimenFiscal::factory()->create(['clave' => '601']);
    $found = RegimenFiscal::find('601');
    expect($found)->not->toBeNull()
        ->and($found->clave)->toBe('601');
});

it('casts boolean fields correctly', function (): void {
    $record = RegimenFiscal::factory()->create([
        'aplica_fisica' => true,
        'aplica_moral' => false,
    ]);
    expect($record->aplica_fisica)->toBeTrue()
        ->and($record->aplica_moral)->toBeFalse();
});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature tests for 9 small SAT catalog models</name>
  <files>
    tests/Feature/Models/RegimenFiscalTest.php
    tests/Feature/Models/UsoCfdiTest.php
    tests/Feature/Models/FormaPagoTest.php
    tests/Feature/Models/MetodoPagoTest.php
    tests/Feature/Models/TipoDeComprobanteTest.php
    tests/Feature/Models/ImpuestoTest.php
    tests/Feature/Models/TipoFactorTest.php
    tests/Feature/Models/ObjetoImpTest.php
    tests/Feature/Models/TipoRelacionTest.php
  </files>
  <action>
Use `php artisan make:test --pest Feature/Models/{ModelName}Test --no-interaction` to scaffold, then implement.

**Each small catalog model test MUST include these Pest tests:**

1. **`it('can be created via factory')`** — Creates a record via factory, asserts it's the correct model class and clave is a string
2. **`it('uses string primary key')`** — Creates a record with a specific clave value, then uses `Model::find('value')` to retrieve it, asserts found and clave matches
3. **`it('does not auto-increment')`** — Asserts `$model->incrementing` is `false` and `$model->getKeyType()` is `'string'`

**Additional tests per model where applicable:**

- **RegimenFiscalTest** — add `it('casts boolean fields correctly')` testing `aplica_fisica` and `aplica_moral` as true PHP booleans
- **UsoCfdiTest** — add `it('casts boolean fields correctly')` for `aplica_fisica` and `aplica_moral`
- **FormaPagoTest** — add `it('casts boolean fields correctly')` for `bancarizado`
- **All models with vigencia dates** — add `it('casts date fields correctly')` testing `vigencia_inicio` as a Carbon date instance (or null)

Use `declare(strict_types=1)` at top of every test file. Use Pest function syntax (`it()`, `test()`, `expect()`). Use `RefreshDatabase` trait (Pest's `uses(Illuminate\Foundation\Testing\RefreshDatabase::class)` at the top).

Run `vendor/bin/pint --dirty --format agent` after creating all files.
Run `php artisan test --compact --filter=Feature/Models` to verify all tests pass.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && php artisan test --compact --filter="RegimenFiscal|UsoCfdi|FormaPago|MetodoPago|TipoDeComprobante|Impuesto|TipoFactor|ObjetoImp|TipoRelacion" 2>&1 | tail -10</automated>
  </verify>
  <done>9 feature test files created and all tests pass. Each model verified: factory creation, string PK lookup, no auto-increment, boolean casts (where applicable), date casts.</done>
</task>

<task type="auto">
  <name>Task 2: Create feature tests for 3 large/special SAT catalog models</name>
  <files>
    tests/Feature/Models/ClaveProdServTest.php
    tests/Feature/Models/ClaveUnidadTest.php
    tests/Feature/Models/TasaOCuotaTest.php
  </files>
  <action>
Create 3 test files for the catalogs with special behavior.

**ClaveProdServTest.php (CAT-06):**

```php
it('can be created via factory')
it('uses string primary key')
it('does not auto-increment')
it('can be searched by descripcion') — Create 3 records via factory with known descripcion values. Query `ClaveProdServ::where('descripcion', 'like', '%{keyword}%')->get()`. Assert the matching record is returned and clave matches.
it('casts estimulo_franja as boolean')
```

**ClaveUnidadTest.php (CAT-07):**

```php
it('can be created via factory')
it('uses string primary key')
it('does not auto-increment')
it('can be searched by nombre') — Create 3 records with known nombre values. Query `ClaveUnidad::where('nombre', 'like', '%{keyword}%')->get()`. Assert the matching record is found.
```

**TasaOCuotaTest.php (CAT-10):**

```php
it('can be created via factory')
it('uses auto-increment primary key') — Assert `$model->incrementing` is `true` (or default)
it('belongs to an impuesto') — Create an Impuesto via factory, create a TasaOCuota with that impuesto's clave, assert `$tasaOCuota->impuesto` is an instance of Impuesto and `$tasaOCuota->impuesto->clave` matches
it('enforces composite unique constraint') — Create a TasaOCuota, attempt to create another with identical (impuesto, factor, valor_minimo, valor_maximo, traslado, retencion), expect a QueryException
it('casts boolean fields correctly') — Test traslado and retencion as PHP booleans
```

Use `declare(strict_types=1)`, Pest syntax, `RefreshDatabase`.

Run `vendor/bin/pint --dirty --format agent`.
Run `php artisan test --compact --filter="ClaveProdServ|ClaveUnidad|TasaOCuota"` to verify.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && php artisan test --compact --filter="ClaveProdServ|ClaveUnidad|TasaOCuota" 2>&1 | tail -10</automated>
  </verify>
  <done>3 feature test files created and all tests pass. ClaveProdServ search by descripcion works. ClaveUnidad search by nombre works. TasaOCuota relationship to Impuesto verified. Composite unique constraint enforced.</done>
</task>

</tasks>

<verification>
- `php artisan test --compact` — full suite passes with zero failures
- All 12 test files exist in `tests/Feature/Models/`
- `vendor/bin/pint --dirty --format agent` reports no changes
</verification>

<success_criteria>
- 12 Pest feature test files covering all SAT catalog models
- All tests pass: `php artisan test --compact` shows zero failures
- ClaveProdServ search test proves Eloquent query returns correct results
- ClaveUnidad search test proves Eloquent query returns correct results
- TasaOCuota relationship test proves belongsTo Impuesto works
- TasaOCuota composite unique constraint test proves duplicates are rejected
</success_criteria>

<output>
After completion, create `.planning/phases/01-cat-logos-sat-base/01-04-SUMMARY.md`
</output>
