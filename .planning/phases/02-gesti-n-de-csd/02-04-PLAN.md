---
phase: 02-gesti-n-de-csd
plan: 04
type: execute
wave: 3
depends_on: [02-01, 02-02]
files_modified:
  - tests/Feature/Models/CsdTest.php
  - tests/Feature/Actions/UploadCsdActionTest.php
  - tests/Feature/Actions/ActivateCsdActionTest.php
  - tests/Feature/Actions/ValidateCsdExpiryActionTest.php
autonomous: true
requirements:
  - CSD-01
  - CSD-02
  - CSD-03
  - CSD-04
  - CSD-05
  - CSD-06
  - CSD-07
must_haves:
  truths:
    - "CsdTest verifies factory creation, auto-increment id, encrypted cast on passphrase_encrypted, date casts, CsdStatus enum cast, soft delete, and CsdBuilder query methods (whereActive, whereExpiring, whereNotExpired)"
    - "UploadCsdActionTest verifies successful upload with valid .cer/.key pair, metadata extraction (NoCertificado, RFC, dates), encrypted .key storage in private disk, .cer storage, temp file cleanup, and error handling for invalid pair/wrong passphrase/non-CSD certificate"
    - "ActivateCsdActionTest verifies single-active enforcement (deactivates previous), expired CSD rejection, and transactional behavior"
    - "ValidateCsdExpiryActionTest verifies RuntimeException when no active CSD exists and when active CSD is expired"
    - "All tests use Pest syntax with expect() assertions and RefreshDatabase trait"
  artifacts:
    - path: "tests/Feature/Models/CsdTest.php"
      provides: "Feature tests for Csd model, casts, soft delete, and builder"
      contains: "CsdBuilder"
    - path: "tests/Feature/Actions/UploadCsdActionTest.php"
      provides: "Feature tests for UploadCsdAction with real certificate parsing"
      contains: "UploadCsdAction"
    - path: "tests/Feature/Actions/ActivateCsdActionTest.php"
      provides: "Feature tests for ActivateCsdAction"
      contains: "ActivateCsdAction"
    - path: "tests/Feature/Actions/ValidateCsdExpiryActionTest.php"
      provides: "Feature tests for ValidateCsdExpiryAction"
      contains: "ValidateCsdExpiryAction"
  key_links:
    - from: "tests/Feature/Actions/UploadCsdActionTest.php"
      to: "app/Actions/UploadCsdAction.php"
      via: "Tests action invocation"
      pattern: "UploadCsdAction"
    - from: "tests/Feature/Models/CsdTest.php"
      to: "app/Models/Csd.php"
      via: "Tests model behavior"
      pattern: "Csd::factory"
---

<objective>
Create comprehensive feature tests for all CSD domain code: model, builder, and all 4 actions.

Purpose: Tests prove that every CSD requirement (CSD-01 through CSD-07) is satisfied. They also protect against regressions when Phase 4 integrates the stamping pipeline with ValidateCsdExpiryAction. These tests are the primary verification mechanism — no manual testing or tinker scripts needed.
Output: 4 Pest test files covering model behavior, encrypted storage, certificate parsing, activation logic, and expiry validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gesti-n-de-csd/02-RESEARCH.md
@.planning/phases/02-gesti-n-de-csd/02-01-SUMMARY.md
@.planning/phases/02-gesti-n-de-csd/02-02-SUMMARY.md
@./.claude/skills/pest-testing/SKILL.md

<interfaces>
<!-- Existing test pattern. From tests/Feature/Models/RegimenFiscalTest.php: -->

```php
<?php
declare(strict_types=1);

use App\Models\RegimenFiscal;
use Carbon\CarbonInterface;

it('can be created via factory', function (): void {
    $record = RegimenFiscal::factory()->create();
    expect($record)->toBeInstanceOf(RegimenFiscal::class)
        ->and($record->clave)->toBeString();
});

it('uses string primary key', function (): void {
    $record = RegimenFiscal::factory()->create(['clave' => '601']);
    $found = RegimenFiscal::find('601');
    expect($found)->not->toBeNull()
        ->and($found->clave)->toBe('601');
});

it('casts boolean fields correctly', function (): void {
    $record = RegimenFiscal::factory()->create([
        'aplica_fisica' => true,
        'aplica_moral' => false,
    ]);
    expect($record->aplica_fisica)->toBeTrue()
        ->and($record->aplica_moral)->toBeFalse();
});

it('casts date fields correctly', function (): void {
    $record = RegimenFiscal::factory()->create([
        'vigencia_inicio' => '2022-01-01',
        'vigencia_fin' => null,
    ]);
    expect($record->vigencia_inicio)->toBeInstanceOf(CarbonInterface::class)
        ->and($record->vigencia_fin)->toBeNull();
});
```

<!-- From 02-01-PLAN: Model and factory -->
<!-- Csd::factory()->create() / ->active()->create() / ->expiringSoon()->create() / ->expired()->create() -->
<!-- Model: id (auto-increment), no_certificado (unique), rfc, fecha_inicio, fecha_fin, status (CsdStatus), key_path, passphrase_encrypted ('encrypted' cast), cer_path, softDeletes -->

<!-- From 02-02-PLAN: Actions -->
<!-- UploadCsdAction::__invoke(UploadCsdData $data): Csd — throws RuntimeException on invalid pair/non-CSD -->
<!-- ActivateCsdAction::__invoke(Csd $csd): Csd — throws RuntimeException on expired -->
<!-- DeactivateCsdAction::__invoke(Csd $csd): Csd -->
<!-- ValidateCsdExpiryAction::__invoke(): Csd — throws RuntimeException if no active or expired -->

<!-- From RESEARCH: Test fixture requirements -->
<!-- phpcfdi/credentials includes test fixture .cer/.key files in its vendor tests directory -->
<!-- Alternatively, mock Credential::openFiles() for tests that don't need real certificate parsing -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CsdTest — model, casts, soft delete, and builder tests</name>
  <files>
    tests/Feature/Models/CsdTest.php
  </files>
  <action>
Use `./vendor/bin/sail php artisan make:test --pest Models/CsdTest --no-interaction` then customize.

The test file MUST follow the existing Pest test pattern from Phase 1 tests. Use `expect()` assertions, `declare(strict_types=1)`, and factory states.

**Tests to write (CSD-03, CSD-07 coverage):**

```php
declare(strict_types=1);

use App\Builders\CsdBuilder;
use App\Enums\CsdStatus;
use App\Models\Csd;
use Carbon\CarbonInterface;
use Illuminate\Support\Facades\Crypt;

// Model basics
it('can be created via factory', function (): void {
    $csd = Csd::factory()->create();
    expect($csd)->toBeInstanceOf(Csd::class)
        ->and($csd->id)->toBeInt()
        ->and($csd->id)->toBeGreaterThan(0);
});

it('uses auto-increment integer primary key', function (): void {
    $csd = new Csd;
    expect($csd->incrementing)->toBeTrue()
        ->and($csd->getKeyName())->toBe('id');
});

// CSD-03: Encrypted cast on passphrase
it('encrypts passphrase on save and decrypts on read', function (): void {
    $plainPassphrase = 'mi-contraseña-secreta-2024';
    $csd = Csd::factory()->create([
        'passphrase_encrypted' => $plainPassphrase,
    ]);

    // Read back from database — 'encrypted' cast should decrypt automatically
    $fresh = Csd::find($csd->id);
    expect($fresh->passphrase_encrypted)->toBe($plainPassphrase);

    // Verify the raw database value is NOT the plaintext
    $rawValue = \DB::table('csds')->where('id', $csd->id)->value('passphrase_encrypted');
    expect($rawValue)->not->toBe($plainPassphrase);

    // Verify the raw value can be decrypted by Laravel Crypt
    expect(Crypt::decryptString($rawValue))->toBe($plainPassphrase);
});

// CSD status cast
it('casts status to CsdStatus enum', function (): void {
    $csd = Csd::factory()->active()->create();
    expect($csd->status)->toBeInstanceOf(CsdStatus::class)
        ->and($csd->status)->toBe(CsdStatus::Active);
});

// Date casts
it('casts date fields correctly', function (): void {
    $csd = Csd::factory()->create([
        'fecha_inicio' => '2024-01-15',
        'fecha_fin' => '2028-01-15',
    ]);
    expect($csd->fecha_inicio)->toBeInstanceOf(CarbonInterface::class)
        ->and($csd->fecha_fin)->toBeInstanceOf(CarbonInterface::class);
});

// Soft delete
it('supports soft delete', function (): void {
    $csd = Csd::factory()->create();
    $id = $csd->id;

    $csd->delete();

    expect(Csd::find($id))->toBeNull()
        ->and(Csd::withTrashed()->find($id))->not->toBeNull();
});

// Factory states
it('creates active CSD with factory state', function (): void {
    $csd = Csd::factory()->active()->create();
    expect($csd->status)->toBe(CsdStatus::Active);
});

it('creates expiring soon CSD with factory state', function (): void {
    $csd = Csd::factory()->expiringSoon()->create();
    expect($csd->status)->toBe(CsdStatus::ExpiringSoon)
        ->and($csd->fecha_fin->diffInDays(now()))->toBeLessThanOrEqual(90);
});

it('creates expired CSD with factory state', function (): void {
    $csd = Csd::factory()->expired()->create();
    expect($csd->status)->toBe(CsdStatus::Expired)
        ->and($csd->fecha_fin->isPast())->toBeTrue();
});

// CSD-07: CsdBuilder query methods
it('uses CsdBuilder as custom query builder', function (): void {
    expect(Csd::query())->toBeInstanceOf(CsdBuilder::class);
});

it('filters active CSDs with whereActive', function (): void {
    Csd::factory()->active()->create();
    Csd::factory()->create(['status' => CsdStatus::Inactive]);
    Csd::factory()->expired()->create();

    $active = Csd::query()->whereActive()->get();
    expect($active)->toHaveCount(1)
        ->and($active->first()->status)->toBe(CsdStatus::Active);
});

it('filters expiring CSDs with whereExpiring', function (): void {
    Csd::factory()->active()->create(['fecha_fin' => now()->addDays(30)]);
    Csd::factory()->active()->create(['fecha_fin' => now()->addYears(3)]);
    Csd::factory()->expiringSoon()->create();
    Csd::factory()->expired()->create();

    $expiring = Csd::query()->whereExpiring()->get();
    // Should include: the active one expiring in 30 days + the expiringSoon one
    expect($expiring->count())->toBeGreaterThanOrEqual(2);
});

it('filters non-expired CSDs with whereNotExpired', function (): void {
    Csd::factory()->active()->create();
    Csd::factory()->expired()->create();

    $notExpired = Csd::query()->whereNotExpired()->get();
    expect($notExpired)->toHaveCount(1);
});
```

**Key patterns:**
- Follow the exact `it('...', function (): void { ... });` pattern from existing tests
- Use `expect()` fluent assertions chained with `->and()`
- Use factory states (`active()`, `expiringSoon()`, `expired()`) for setup
- Test the encrypted cast by comparing raw DB value to plaintext (CSD-03)
- Test builder methods by creating mixed records and asserting filtered counts (CSD-07)

Run `vendor/bin/pint --dirty --format agent` after creating the file.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php artisan test --compact --filter=CsdTest 2>&1 | tail -10</automated>
  </verify>
  <done>CsdTest has 12+ tests covering factory creation, auto-increment id, encrypted passphrase cast (CSD-03), CsdStatus enum cast, date casts, soft delete, factory states, CsdBuilder::whereActive() (CSD-07), CsdBuilder::whereExpiring() (CSD-07), and CsdBuilder::whereNotExpired(). All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create action tests — UploadCsdAction, ActivateCsdAction, ValidateCsdExpiryAction</name>
  <files>
    tests/Feature/Actions/UploadCsdActionTest.php
    tests/Feature/Actions/ActivateCsdActionTest.php
    tests/Feature/Actions/ValidateCsdExpiryActionTest.php
  </files>
  <action>
Create the `tests/Feature/Actions/` directory if it does not exist.

**Strategy for UploadCsdActionTest:** The action calls `Credential::openFiles()` from `phpcfdi/credentials`. To test properly, we need real .cer/.key test fixtures. Two approaches:

1. **Preferred: Use phpcfdi/credentials test fixtures.** After installing the package, check if test fixture files exist at `vendor/phpcfdi/credentials/tests/_files/`. Copy the CSD test .cer and .key files to `tests/fixtures/csd/`. If they don't exist at that path, search the vendor directory.

2. **Fallback: Mock Credential::openFiles().** If real fixtures are not available, mock the `Credential` class. However, mocking reduces confidence in the integration.

The executor should first check:
```bash
find vendor/phpcfdi/credentials/tests -name "*.cer" -o -name "*.key" 2>/dev/null | head -10
```

If CSD test fixtures are found, copy them to `tests/fixtures/csd/` and use the real passphrase from the phpcfdi test suite (usually `'12345678a'` for SAT test certificates).

If NO fixtures are found, use mocking approach (documented below).

**UploadCsdActionTest.php (CSD-01, CSD-02, CSD-04, CSD-05):**

```php
declare(strict_types=1);

use App\Actions\UploadCsdAction;
use App\Data\UploadCsdData;
use App\Enums\CsdStatus;
use App\Models\Csd;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Support\Facades\Storage;

// --- Tests using real fixtures (preferred) ---

// CSD-01, CSD-02: Upload .cer and .key successfully
it('creates a CSD record from valid .cer and .key files', function (): void {
    Storage::fake('local');
    // Use test fixtures — adjust paths based on what phpcfdi/credentials provides
    $cerPath = base_path('tests/fixtures/csd/EKU9003173C9.cer');
    $keyPath = base_path('tests/fixtures/csd/EKU9003173C9.key');
    $passphrase = '12345678a';

    // Skip if fixtures don't exist
    if (! file_exists($cerPath) || ! file_exists($keyPath)) {
        $this->markTestSkipped('CSD test fixtures not found. Copy from phpcfdi/credentials test suite.');
    }

    // Copy fixtures to temp so the action can read them
    $tempCer = tempnam(sys_get_temp_dir(), 'cer');
    $tempKey = tempnam(sys_get_temp_dir(), 'key');
    copy($cerPath, $tempCer);
    copy($keyPath, $tempKey);

    $data = new UploadCsdData(
        cerFilePath: $tempCer,
        keyFilePath: $tempKey,
        passphrase: $passphrase,
    );

    $csd = app(UploadCsdAction::class)($data);

    expect($csd)->toBeInstanceOf(Csd::class)
        ->and($csd->no_certificado)->toBeString()->not->toBeEmpty()
        ->and($csd->rfc)->toBeString()->not->toBeEmpty();
});

// CSD-05: Extract NoCertificado and validity dates
it('extracts NoCertificado and validity dates from .cer', function (): void {
    Storage::fake('local');
    $cerPath = base_path('tests/fixtures/csd/EKU9003173C9.cer');
    $keyPath = base_path('tests/fixtures/csd/EKU9003173C9.key');
    $passphrase = '12345678a';

    if (! file_exists($cerPath) || ! file_exists($keyPath)) {
        $this->markTestSkipped('CSD test fixtures not found.');
    }

    $tempCer = tempnam(sys_get_temp_dir(), 'cer');
    $tempKey = tempnam(sys_get_temp_dir(), 'key');
    copy($cerPath, $tempCer);
    copy($keyPath, $tempKey);

    $csd = app(UploadCsdAction::class)(new UploadCsdData($tempCer, $tempKey, $passphrase));

    expect($csd->no_certificado)->not->toBeEmpty()
        ->and($csd->fecha_inicio)->not->toBeNull()
        ->and($csd->fecha_fin)->not->toBeNull()
        ->and($csd->fecha_fin->gt($csd->fecha_inicio))->toBeTrue();
});

// CSD-04: .key file encrypted in private storage
it('stores .key file encrypted in private storage', function (): void {
    Storage::fake('local');
    $cerPath = base_path('tests/fixtures/csd/EKU9003173C9.cer');
    $keyPath = base_path('tests/fixtures/csd/EKU9003173C9.key');
    $passphrase = '12345678a';

    if (! file_exists($cerPath) || ! file_exists($keyPath)) {
        $this->markTestSkipped('CSD test fixtures not found.');
    }

    $tempCer = tempnam(sys_get_temp_dir(), 'cer');
    $tempKey = tempnam(sys_get_temp_dir(), 'key');
    copy($cerPath, $tempCer);
    copy($keyPath, $tempKey);

    $originalKeyContents = file_get_contents($keyPath);

    $csd = app(UploadCsdAction::class)(new UploadCsdData($tempCer, $tempKey, $passphrase));

    // Verify file is stored
    Storage::disk('local')->assertExists($csd->key_path);

    // Verify stored contents are encrypted (not raw binary)
    $storedContents = Storage::disk('local')->get($csd->key_path);
    expect($storedContents)->not->toBe($originalKeyContents);

    // Verify stored contents can be decrypted back to original
    $decrypted = Crypt::decryptString($storedContents);
    expect($decrypted)->toBe($originalKeyContents);
});

// Error: invalid pair
it('throws RuntimeException for invalid .cer/.key pair', function (): void {
    Storage::fake('local');
    $tempCer = tempnam(sys_get_temp_dir(), 'cer');
    $tempKey = tempnam(sys_get_temp_dir(), 'key');
    file_put_contents($tempCer, 'invalid-cer-data');
    file_put_contents($tempKey, 'invalid-key-data');

    app(UploadCsdAction::class)(new UploadCsdData($tempCer, $tempKey, 'wrong'));
})->throws(RuntimeException::class);

// Temp file cleanup
it('cleans up temp files after successful upload', function (): void {
    Storage::fake('local');
    $cerPath = base_path('tests/fixtures/csd/EKU9003173C9.cer');
    $keyPath = base_path('tests/fixtures/csd/EKU9003173C9.key');
    $passphrase = '12345678a';

    if (! file_exists($cerPath) || ! file_exists($keyPath)) {
        $this->markTestSkipped('CSD test fixtures not found.');
    }

    $tempCer = tempnam(sys_get_temp_dir(), 'cer');
    $tempKey = tempnam(sys_get_temp_dir(), 'key');
    copy($cerPath, $tempCer);
    copy($keyPath, $tempKey);

    app(UploadCsdAction::class)(new UploadCsdData($tempCer, $tempKey, $passphrase));

    expect(file_exists($tempCer))->toBeFalse()
        ->and(file_exists($tempKey))->toBeFalse();
});
```

**IMPORTANT fixture note:** The test fixtures referenced above use `EKU9003173C9` which is a common SAT test RFC. The executor MUST:
1. Check `vendor/phpcfdi/credentials/tests/_files/` for available test files
2. Identify the correct filenames and passphrase from the phpcfdi test suite
3. Copy the CSD (not FIEL) test files to `tests/fixtures/csd/`
4. Adjust filenames and passphrase in the tests accordingly
5. If no CSD fixtures exist (only FIEL), the `isCsd()` check in the action may fail — adjust the test or mock accordingly

**ActivateCsdActionTest.php (CSD-06 partial):**

```php
declare(strict_types=1);

use App\Actions\ActivateCsdAction;
use App\Enums\CsdStatus;
use App\Models\Csd;

it('activates a CSD and sets status to Active', function (): void {
    $csd = Csd::factory()->create(['status' => CsdStatus::Inactive]);

    $result = app(ActivateCsdAction::class)($csd);

    expect($result->status)->toBe(CsdStatus::Active);
});

it('deactivates the previously active CSD when activating a new one', function (): void {
    $previousActive = Csd::factory()->active()->create();
    $newCsd = Csd::factory()->create(['status' => CsdStatus::Inactive]);

    app(ActivateCsdAction::class)($newCsd);

    expect($previousActive->refresh()->status)->toBe(CsdStatus::Inactive)
        ->and($newCsd->refresh()->status)->toBe(CsdStatus::Active);
});

it('ensures only one CSD is active at a time', function (): void {
    Csd::factory()->active()->create();
    Csd::factory()->active()->create();
    $third = Csd::factory()->create(['status' => CsdStatus::Inactive]);

    app(ActivateCsdAction::class)($third);

    $activeCount = Csd::query()->whereActive()->count();
    expect($activeCount)->toBe(1);
});

it('throws RuntimeException when activating an expired CSD', function (): void {
    $expired = Csd::factory()->expired()->create();

    app(ActivateCsdAction::class)($expired);
})->throws(RuntimeException::class, 'No se puede activar un CSD expirado');
```

**ValidateCsdExpiryActionTest.php (CSD-06):**

```php
declare(strict_types=1);

use App\Actions\ValidateCsdExpiryAction;
use App\Enums\CsdStatus;
use App\Models\Csd;

// CSD-06: Block stamping when no active CSD
it('throws RuntimeException when no active CSD exists', function (): void {
    // No CSDs in database at all
    app(ValidateCsdExpiryAction::class)();
})->throws(RuntimeException::class, 'No hay CSD activo');

it('throws RuntimeException when only inactive CSDs exist', function (): void {
    Csd::factory()->create(['status' => CsdStatus::Inactive]);
    Csd::factory()->expired()->create();

    app(ValidateCsdExpiryAction::class)();
})->throws(RuntimeException::class, 'No hay CSD activo');

// CSD-06: Block stamping when active CSD is expired
it('throws RuntimeException when active CSD is expired', function (): void {
    Csd::factory()->create([
        'status' => CsdStatus::Active,
        'fecha_fin' => now()->subDay(),
    ]);

    app(ValidateCsdExpiryAction::class)();
})->throws(RuntimeException::class, 'El CSD está expirado');

// Success case
it('returns the active CSD when valid and not expired', function (): void {
    $activeCsd = Csd::factory()->active()->create();

    $result = app(ValidateCsdExpiryAction::class)();

    expect($result)->toBeInstanceOf(Csd::class)
        ->and($result->id)->toBe($activeCsd->id)
        ->and($result->status)->toBe(CsdStatus::Active);
});
```

Create all 3 test files. Run `vendor/bin/pint --dirty --format agent` after creating all files.

Then run the full test suite:
```bash
./vendor/bin/sail php artisan test --compact --filter=Csd
```

If UploadCsdAction tests fail due to missing fixtures, note it in the summary but do NOT delete the tests — mark them as skipped.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php artisan test --compact --filter=Csd 2>&1 | tail -15</automated>
  </verify>
  <done>CsdTest: 12+ tests for model/casts/builder. UploadCsdActionTest: 5+ tests for upload/extract/encrypt/error/cleanup. ActivateCsdActionTest: 4 tests for activation/deactivation/single-active/expired-rejection. ValidateCsdExpiryActionTest: 4 tests for no-active/inactive-only/expired/success. All tests pass (or skipped with clear reason if fixtures missing). Full suite green.</done>
</task>

</tasks>

<verification>
- `./vendor/bin/sail php artisan test --compact --filter=CsdTest` passes
- `./vendor/bin/sail php artisan test --compact --filter=UploadCsdActionTest` passes (or skipped tests with clear reason)
- `./vendor/bin/sail php artisan test --compact --filter=ActivateCsdActionTest` passes
- `./vendor/bin/sail php artisan test --compact --filter=ValidateCsdExpiryActionTest` passes
- `./vendor/bin/sail php artisan test --compact` full suite passes (no regressions from Phase 1)
- `vendor/bin/pint --dirty --format agent` reports no changes needed
</verification>

<success_criteria>
- 20+ feature tests across 4 test files
- CSD-03 proven: encrypted cast round-trips passphrase correctly, raw DB value is not plaintext
- CSD-04 proven: .key stored encrypted in private disk, decryptable back to original
- CSD-05 proven: NoCertificado, RFC, and validity dates extracted from .cer
- CSD-06 proven: RuntimeException when no active CSD or when active CSD is expired
- CSD-07 proven: CsdBuilder::whereActive() and whereExpiring() filter correctly
- All tests use Pest syntax following existing project conventions
</success_criteria>

<output>
After completion, create `.planning/phases/02-gesti-n-de-csd/02-04-SUMMARY.md`
</output>
