---
phase: 02-gesti-n-de-csd
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - app/Filament/Resources/CsdResource.php
  - app/Filament/Resources/CsdResource/Pages/ListCsds.php
  - app/Filament/Resources/CsdResource/Pages/CreateCsd.php
  - app/Filament/Resources/CsdResource/Pages/ViewCsd.php
  - app/Filament/Widgets/CsdExpiryWarningWidget.php
  - resources/views/filament/widgets/csd-expiry-warning.blade.php
autonomous: true
requirements:
  - CSD-01
  - CSD-02
  - CSD-07
must_haves:
  truths:
    - "CsdResource uses navigationGroup 'Configuraci\u00f3n' (not 'Cat\u00e1logos SAT')"
    - "CSD list table shows NoCertificado, RFC, fecha_inicio, fecha_fin, status badge (color-coded via CsdStatus enum), and created_at"
    - "Upload form in CreateCsd page collects .cer file, .key file, and passphrase — calls UploadCsdAction on submit"
    - "ViewCsd page shows read-only CSD details (immutable records — no edit page)"
    - "List table has 'Activar' action (visible when not active) and 'Desactivar' action (visible when active) with confirmation modals"
    - "CsdExpiryWarningWidget shows a dismissible banner on the Filament dashboard when any CSD expires within 90 days"
    - "CSD records support soft delete from the list table"
  artifacts:
    - path: "app/Filament/Resources/CsdResource.php"
      provides: "Filament resource for CSD management under Configuraci\u00f3n group"
      contains: "navigationGroup"
    - path: "app/Filament/Resources/CsdResource/Pages/ListCsds.php"
      provides: "List page with activate/deactivate row actions"
      contains: "ListRecords"
    - path: "app/Filament/Resources/CsdResource/Pages/CreateCsd.php"
      provides: "Upload form page calling UploadCsdAction"
      contains: "UploadCsdAction"
    - path: "app/Filament/Resources/CsdResource/Pages/ViewCsd.php"
      provides: "Read-only detail view"
      contains: "ViewRecord"
    - path: "app/Filament/Widgets/CsdExpiryWarningWidget.php"
      provides: "Dashboard expiry warning banner"
      contains: "whereExpiring"
    - path: "resources/views/filament/widgets/csd-expiry-warning.blade.php"
      provides: "Blade view for expiry warning widget"
      contains: "d\u00edas restantes"
  key_links:
    - from: "app/Filament/Resources/CsdResource/Pages/CreateCsd.php"
      to: "app/Actions/UploadCsdAction.php"
      via: "Action invocation in handleRecordCreation"
      pattern: "UploadCsdAction"
    - from: "app/Filament/Resources/CsdResource/Pages/ListCsds.php"
      to: "app/Actions/ActivateCsdAction.php"
      via: "Table row action"
      pattern: "ActivateCsdAction"
    - from: "app/Filament/Widgets/CsdExpiryWarningWidget.php"
      to: "app/Builders/CsdBuilder.php"
      via: "Query builder method"
      pattern: "whereExpiring"
---

<objective>
Create the Filament CSD resource (list, create/upload, view pages) and dashboard expiry warning widget.

Purpose: This is the user-facing interface for CSD management. Users upload certificates through the create page, view/manage them in the list, and see expiry warnings on the dashboard. The resource consumes the actions and builder from Plans 01 and 02.
Output: 1 Filament resource with 3 pages, 1 dashboard widget with Blade view — all following existing project conventions (Filament 5 Schema API, `string|UnitEnum|null` types, Spanish labels).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gesti-n-de-csd/02-RESEARCH.md
@.planning/phases/02-gesti-n-de-csd/02-01-SUMMARY.md

<interfaces>
<!-- Existing Filament resource pattern. From app/Filament/Resources/RegimenFiscalResource.php: -->

```php
<?php
declare(strict_types=1);
namespace App\Filament\Resources;

use App\Models\RegimenFiscal;
use BackedEnum;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Table;
use UnitEnum;

final class RegimenFiscalResource extends Resource
{
    protected static ?string $model = RegimenFiscal::class;
    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-rectangle-stack';
    protected static string|UnitEnum|null $navigationGroup = 'Catálogos SAT';
    protected static ?string $modelLabel = 'Régimen Fiscal';
    protected static ?string $pluralModelLabel = 'Regímenes Fiscales';

    public static function form(Schema $schema): Schema
    {
        return $schema;
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([...])
            ->defaultSort('clave')
            ->paginated([25, 50, 100]);
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListRegimenFiscals::route('/'),
        ];
    }
}
```

<!-- From 02-01-PLAN: Csd model fields -->
<!-- no_certificado, rfc, fecha_inicio, fecha_fin, status (CsdStatus), key_path, passphrase_encrypted, cer_path, created_at -->

<!-- From 02-01-PLAN: CsdStatus enum with HasColor/HasLabel -->
<!-- Active='active' (success/Activo), ExpiringSoon='expiring_soon' (warning/Por vencer), Expired='expired' (danger/Expirado), Inactive='inactive' (gray/Inactivo) -->

<!-- From 02-02-PLAN: Action signatures -->
<!-- UploadCsdAction::__invoke(UploadCsdData $data): Csd -->
<!-- ActivateCsdAction::__invoke(Csd $csd): Csd -->
<!-- DeactivateCsdAction::__invoke(Csd $csd): Csd -->

<!-- From RESEARCH: Filament FileUpload config for .cer/.key -->
<!-- acceptedFileTypes: include 'application/octet-stream' as fallback -->
<!-- mimeTypeMap for .cer and .key extensions -->
<!-- disk('local'), directory('csd/temp'), visibility('private') -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CsdResource with list table, create page, and view page</name>
  <files>
    app/Filament/Resources/CsdResource.php
    app/Filament/Resources/CsdResource/Pages/ListCsds.php
    app/Filament/Resources/CsdResource/Pages/CreateCsd.php
    app/Filament/Resources/CsdResource/Pages/ViewCsd.php
  </files>
  <action>
Use `./vendor/bin/sail php artisan make:filament-resource Csd --view --no-interaction` to scaffold, then heavily customize.

**CsdResource.php — Main resource:**

```php
declare(strict_types=1);
namespace App\Filament\Resources;

use App\Enums\CsdStatus;
use App\Filament\Resources\CsdResource\Pages;
use App\Models\Csd;
use BackedEnum;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Table;
use UnitEnum;

final class CsdResource extends Resource
{
    protected static ?string $model = Csd::class;

    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-shield-check';

    protected static string|UnitEnum|null $navigationGroup = 'Configuración';

    protected static ?string $modelLabel = 'Certificado de Sello Digital';

    protected static ?string $pluralModelLabel = 'Certificados de Sello Digital';

    public static function form(Schema $schema): Schema
    {
        return $schema;
        // Upload form is handled in CreateCsd page, not here
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                TextColumn::make('no_certificado')
                    ->label('No. Certificado')
                    ->searchable()
                    ->sortable(),
                TextColumn::make('rfc')
                    ->label('RFC')
                    ->searchable(),
                TextColumn::make('fecha_inicio')
                    ->label('Vigencia desde')
                    ->date('d/m/Y')
                    ->sortable(),
                TextColumn::make('fecha_fin')
                    ->label('Vigencia hasta')
                    ->date('d/m/Y')
                    ->sortable(),
                TextColumn::make('status')
                    ->label('Estado')
                    ->badge(),
                TextColumn::make('created_at')
                    ->label('Fecha de carga')
                    ->date('d/m/Y')
                    ->sortable(),
            ])
            ->defaultSort('created_at', 'desc')
            ->paginated([10, 25, 50]);
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListCsds::route('/'),
            'create' => Pages\CreateCsd::route('/create'),
            'view' => Pages\ViewCsd::route('/{record}'),
        ];
    }
}
```

**IMPORTANT conventions from Phase 1:**
- `string|BackedEnum|null` for `$navigationIcon` (not `?string`)
- `string|UnitEnum|null` for `$navigationGroup` (not `?string`)
- `Schema` parameter in `form()` (not `Form`)
- `final class`
- `declare(strict_types=1)`

**ListCsds.php — List page with activate/deactivate/delete row actions:**

```php
declare(strict_types=1);
namespace App\Filament\Resources\CsdResource\Pages;

use App\Actions\ActivateCsdAction;
use App\Actions\DeactivateCsdAction;
use App\Enums\CsdStatus;
use App\Filament\Resources\CsdResource;
use App\Models\Csd;
use Filament\Actions;
use Filament\Resources\Pages\ListRecords;
use Filament\Tables;

final class ListCsds extends ListRecords
{
    protected static string $resource = CsdResource::class;

    protected function getHeaderActions(): array
    {
        return [
            Actions\CreateAction::make()
                ->label('Subir CSD'),
        ];
    }

    protected function getTableActions(): array
    {
        return [
            Tables\Actions\ViewAction::make(),

            Tables\Actions\Action::make('activar')
                ->label('Activar')
                ->icon('heroicon-o-check-circle')
                ->color('success')
                ->requiresConfirmation()
                ->modalHeading('¿Activar este CSD?')
                ->modalDescription('Se desactivará el CSD activo actual y este certificado será usado para firmar facturas.')
                ->action(fn (Csd $record) => app(ActivateCsdAction::class)($record))
                ->visible(fn (Csd $record): bool => $record->status !== CsdStatus::Active && ! $record->fecha_fin->isPast()),

            Tables\Actions\Action::make('desactivar')
                ->label('Desactivar')
                ->icon('heroicon-o-x-circle')
                ->color('warning')
                ->requiresConfirmation()
                ->modalHeading('¿Desactivar este CSD?')
                ->modalDescription('No podrás timbrar facturas hasta que actives otro certificado.')
                ->action(fn (Csd $record) => app(DeactivateCsdAction::class)($record))
                ->visible(fn (Csd $record): bool => $record->status === CsdStatus::Active),

            Tables\Actions\DeleteAction::make()
                ->label('Eliminar'),
        ];
    }
}
```

**NOTE:** The `getTableActions()` method returns the row actions for the list table. Verify in Filament 5 docs whether this method is the correct approach, or whether actions should be defined in the `table()` method of the resource using `->actions([...])`. If the resource `table()` approach is used in existing code, follow that pattern instead. The executor should check `search-docs` for the correct Filament 5 pattern and adjust accordingly.

**Alternative (if getTableActions doesn't exist in Filament 5):** Move the actions array to `CsdResource::table()`:
```php
->actions([
    Tables\Actions\ViewAction::make(),
    Tables\Actions\Action::make('activar')...
    Tables\Actions\Action::make('desactivar')...
    Tables\Actions\DeleteAction::make(),
])
```

**CreateCsd.php — Upload form using CreateRecord with custom handleRecordCreation:**

The key challenge: Filament's CreateRecord normally maps form fields to model attributes. Our upload form has file fields and a passphrase that are NOT model columns. Solution: Override `handleRecordCreation()` to intercept the form data and call `UploadCsdAction` instead of letting Filament save directly.

```php
declare(strict_types=1);
namespace App\Filament\Resources\CsdResource\Pages;

use App\Actions\UploadCsdAction;
use App\Data\UploadCsdData;
use App\Filament\Resources\CsdResource;
use App\Models\Csd;
use Filament\Forms\Components\FileUpload;
use Filament\Forms\Components\TextInput;
use Filament\Notifications\Notification;
use Filament\Resources\Pages\CreateRecord;
use Filament\Schemas\Schema;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Storage;
use RuntimeException;

final class CreateCsd extends CreateRecord
{
    protected static string $resource = CsdResource::class;

    protected static ?string $title = 'Subir Certificado de Sello Digital';

    public function form(Schema $schema): Schema
    {
        return $schema->components([
            FileUpload::make('cer_file')
                ->label('Archivo .cer')
                ->disk('local')
                ->directory('csd/temp')
                ->visibility('private')
                ->acceptedFileTypes([
                    'application/x-x509-ca-cert',
                    'application/pkix-cert',
                    'application/octet-stream',
                ])
                ->maxSize(512)
                ->required(),

            FileUpload::make('key_file')
                ->label('Archivo .key')
                ->disk('local')
                ->directory('csd/temp')
                ->visibility('private')
                ->acceptedFileTypes([
                    'application/pkcs8',
                    'application/octet-stream',
                ])
                ->maxSize(512)
                ->required(),

            TextInput::make('passphrase')
                ->label('Contraseña del archivo .key')
                ->password()
                ->revealable()
                ->required(),
        ]);
    }

    protected function handleRecordCreation(array $data): Model
    {
        // Resolve full file paths from Filament's stored relative paths
        $cerPath = Storage::disk('local')->path($data['cer_file']);
        $keyPath = Storage::disk('local')->path($data['key_file']);

        try {
            $csd = app(UploadCsdAction::class)(
                new UploadCsdData(
                    cerFilePath: $cerPath,
                    keyFilePath: $keyPath,
                    passphrase: $data['passphrase'],
                ),
            );
        } catch (RuntimeException $e) {
            Notification::make()
                ->danger()
                ->title('Error al procesar el certificado')
                ->body($e->getMessage())
                ->persistent()
                ->send();

            $this->halt();
        }

        Notification::make()
            ->success()
            ->title('CSD cargado correctamente')
            ->body("Certificado {$csd->no_certificado} registrado exitosamente.")
            ->send();

        return $csd;
    }

    protected function getRedirectUrl(): string
    {
        return $this->getResource()::getUrl('view', ['record' => $this->record]);
    }
}
```

**ViewCsd.php — Read-only detail view:**

```php
declare(strict_types=1);
namespace App\Filament\Resources\CsdResource\Pages;

use App\Filament\Resources\CsdResource;
use Filament\Infolists\Components\TextEntry;
use Filament\Infolists\Infolist;
use Filament\Resources\Pages\ViewRecord;

final class ViewCsd extends ViewRecord
{
    protected static string $resource = CsdResource::class;

    public function infolist(Infolist $infolist): Infolist
    {
        return $infolist->schema([
            TextEntry::make('no_certificado')
                ->label('No. Certificado'),
            TextEntry::make('rfc')
                ->label('RFC'),
            TextEntry::make('fecha_inicio')
                ->label('Vigencia desde')
                ->date('d/m/Y'),
            TextEntry::make('fecha_fin')
                ->label('Vigencia hasta')
                ->date('d/m/Y'),
            TextEntry::make('status')
                ->label('Estado')
                ->badge(),
            TextEntry::make('created_at')
                ->label('Fecha de carga')
                ->date('d/m/Y H:i'),
        ]);
    }
}
```

**IMPORTANT Filament 5 notes:**
- Use `search-docs` to verify the exact Filament 5 API for `CreateRecord::handleRecordCreation()`, `halt()`, and `Infolist` in ViewRecord. The API may differ from Filament 4.
- If `handleRecordCreation` does not exist in Filament 5, use `mutateFormDataBeforeCreate()` combined with `afterCreate()` lifecycle hooks instead.
- If `Infolist` API changed in Filament 5, check the docs and adjust accordingly.
- The executor MUST run `search-docs` with queries like `['create record', 'handleRecordCreation', 'view record infolist']` to verify patterns.

Run `vendor/bin/pint --dirty --format agent` after creating all files.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && test -f app/Filament/Resources/CsdResource.php && test -f app/Filament/Resources/CsdResource/Pages/ListCsds.php && test -f app/Filament/Resources/CsdResource/Pages/CreateCsd.php && test -f app/Filament/Resources/CsdResource/Pages/ViewCsd.php && ./vendor/bin/sail php -l app/Filament/Resources/CsdResource.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>CsdResource exists under "Configuración" navigation group with list table (NoCertificado, RFC, dates, status badge, upload date), row actions (Activar, Desactivar, Eliminar), create page with FileUpload for .cer/.key and passphrase, and read-only view page. All Spanish labels. Follows Filament 5 conventions.</done>
</task>

<task type="auto">
  <name>Task 2: Create CsdExpiryWarningWidget and Blade view</name>
  <files>
    app/Filament/Widgets/CsdExpiryWarningWidget.php
    resources/views/filament/widgets/csd-expiry-warning.blade.php
  </files>
  <action>
**CsdExpiryWarningWidget.php** — Dashboard widget that shows when a CSD is within 90 days of expiration.

```php
declare(strict_types=1);

namespace App\Filament\Widgets;

use App\Models\Csd;
use Filament\Widgets\Widget;

final class CsdExpiryWarningWidget extends Widget
{
    protected static string $view = 'filament.widgets.csd-expiry-warning';

    protected int|string|array $columnSpan = 'full';

    protected static ?int $sort = -1;  // Show at top of dashboard

    protected static bool $isLazy = true;

    public ?Csd $expiringCsd = null;

    public ?int $daysRemaining = null;

    public function mount(): void
    {
        $this->expiringCsd = Csd::query()->whereExpiring()->first();

        if ($this->expiringCsd !== null) {
            $this->daysRemaining = (int) now()->diffInDays($this->expiringCsd->fecha_fin, absolute: false);
        }
    }

    public static function canView(): bool
    {
        return Csd::query()->whereExpiring()->exists();
    }
}
```

**NOTE:** Verify in Filament 5 docs whether `canView()` is the correct static method for conditional widget visibility. In Filament 3/4 it was `canView()`. The executor should check `search-docs` with query `['widget canView', 'conditional widget']` and adjust if needed.

**Alternative if `canView()` doesn't exist:** Remove it and conditionally render in the Blade view instead:
```blade
@if($this->expiringCsd)
  {{-- show banner --}}
@endif
```

**Blade view** at `resources/views/filament/widgets/csd-expiry-warning.blade.php`:

```blade
<x-filament-widgets::widget>
    @if($this->expiringCsd)
        <x-filament::section>
            <div class="flex items-center gap-x-3 rounded-lg bg-warning-50 p-4 ring-1 ring-warning-200 dark:bg-warning-950 dark:ring-warning-800">
                <x-heroicon-o-exclamation-triangle class="h-6 w-6 text-warning-500" />
                <div class="flex-1">
                    <p class="text-sm font-medium text-warning-800 dark:text-warning-200">
                        El certificado de sello digital
                        <span class="font-bold">{{ $this->expiringCsd->no_certificado }}</span>
                        vence en
                        <span class="font-bold">{{ $this->daysRemaining }}</span>
                        {{ $this->daysRemaining === 1 ? 'día' : 'días' }}.
                    </p>
                    <p class="mt-1 text-xs text-warning-600 dark:text-warning-400">
                        Fecha de vencimiento: {{ $this->expiringCsd->fecha_fin->format('d/m/Y') }}.
                        Suba un nuevo CSD antes de que expire para evitar interrupciones en el timbrado.
                    </p>
                </div>
            </div>
        </x-filament::section>
    @endif
</x-filament-widgets::widget>
```

Create the directory `resources/views/filament/widgets/` if it does not exist.

**Filament 5 widget Blade notes:**
- The executor should verify the exact Blade component names (`x-filament-widgets::widget`, `x-filament::section`) using `search-docs` queries like `['custom widget view', 'widget blade template']`.
- If the component names changed in Filament 5, adjust accordingly.

Run `vendor/bin/pint --dirty --format agent` after creating the PHP file.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && test -f app/Filament/Widgets/CsdExpiryWarningWidget.php && test -f resources/views/filament/widgets/csd-expiry-warning.blade.php && ./vendor/bin/sail php -l app/Filament/Widgets/CsdExpiryWarningWidget.php && vendor/bin/pint --dirty --format agent 2>&1 | tail -3</automated>
  </verify>
  <done>CsdExpiryWarningWidget exists with full-width dashboard banner showing certificate number and days remaining. Blade view renders warning with Spanish text, conditional on expiring CSD existence. Widget uses CsdBuilder::whereExpiring() and is lazy-loaded.</done>
</task>

</tasks>

<verification>
- CsdResource appears in Filament navigation under "Configuración" group
- List table shows correct columns with status badge colors
- "Subir CSD" button navigates to create page with file upload form
- View page shows read-only CSD details with infolist
- Activate/Deactivate actions visible in appropriate states
- Dashboard widget renders when an expiring CSD exists
- `vendor/bin/pint --dirty --format agent` reports no changes needed
- `./vendor/bin/sail php artisan test --compact` passes (no regressions)
</verification>

<success_criteria>
- CsdResource under "Configuración" navigation group with Spanish labels
- List table with NoCertificado, RFC, dates, status badge, upload date, and row actions
- Create page with FileUpload (.cer, .key) and passphrase calling UploadCsdAction
- View page with read-only infolist (no edit — immutable records)
- Activate/Deactivate/Delete row actions with confirmation modals
- CsdExpiryWarningWidget on dashboard with days-remaining count
</success_criteria>

<output>
After completion, create `.planning/phases/02-gesti-n-de-csd/02-03-SUMMARY.md`
</output>
