---
phase: 02-gesti-n-de-csd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - composer.lock
  - database/migrations/2026_02_28_100000_create_csds_table.php
  - app/Models/Csd.php
  - app/Enums/CsdStatus.php
  - app/Builders/CsdBuilder.php
  - database/factories/CsdFactory.php
  - app/Data/UploadCsdData.php
  - app/Data/CsdData.php
autonomous: true
requirements:
  - CSD-03
  - CSD-04
must_haves:
  truths:
    - "phpcfdi/credentials and spatie/laravel-data are installed and autoloadable"
    - "csds table exists with auto-increment id, no_certificado (unique), rfc, fecha_inicio, fecha_fin, status, key_path, passphrase_encrypted (TEXT), timestamps, softDeletes, and indexes on status and fecha_fin"
    - "Csd model uses 'encrypted' cast on passphrase_encrypted, CsdStatus enum cast on status, date casts on fecha_inicio/fecha_fin, SoftDeletes trait, and #[UseEloquentBuilder(CsdBuilder::class)] attribute"
    - "CsdStatus backed enum implements HasColor and HasLabel with Spanish labels"
    - "CsdBuilder has whereActive(), whereExpiring(int $withinDays = 90), and whereNotExpired() methods"
    - "CsdFactory produces valid Csd records for testing"
    - "UploadCsdData and CsdData are spatie/laravel-data DTOs"
  artifacts:
    - path: "app/Models/Csd.php"
      provides: "Thin Eloquent model for CSD records with encrypted casts and SoftDeletes"
      contains: "UseEloquentBuilder(CsdBuilder::class)"
    - path: "app/Enums/CsdStatus.php"
      provides: "Backed enum with Active, ExpiringSoon, Expired, Inactive cases"
      contains: "implements HasColor, HasLabel"
    - path: "app/Builders/CsdBuilder.php"
      provides: "Custom query builder with CSD-specific query methods"
      contains: "whereActive"
    - path: "app/Data/UploadCsdData.php"
      provides: "Input DTO for the upload action"
      contains: "class UploadCsdData"
    - path: "app/Data/CsdData.php"
      provides: "Output DTO for CSD display"
      contains: "class CsdData"
  key_links:
    - from: "app/Models/Csd.php"
      to: "app/Builders/CsdBuilder.php"
      via: "#[UseEloquentBuilder] attribute"
      pattern: "UseEloquentBuilder(CsdBuilder::class)"
    - from: "app/Models/Csd.php"
      to: "app/Enums/CsdStatus.php"
      via: "Eloquent cast"
      pattern: "'status' => CsdStatus::class"
    - from: "app/Models/Csd.php"
      to: "database/migrations/*_create_csds_table.php"
      via: "Eloquent convention"
      pattern: "csds"
---

<objective>
Install required dependencies and create the complete data layer foundation for CSD management.

Purpose: Every subsequent plan (actions, Filament UI, tests) depends on the Csd model, CsdStatus enum, CsdBuilder, and DTOs. This plan establishes all data contracts first so plans 02 and 03 can execute in parallel.
Output: 2 new Composer dependencies, 1 migration, 1 model, 1 enum, 1 builder, 1 factory, 2 DTOs — all following existing project conventions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gesti-n-de-csd/02-RESEARCH.md

<interfaces>
<!-- Existing model pattern to follow. From app/Models/RegimenFiscal.php: -->

```php
<?php
declare(strict_types=1);
namespace App\Models;

use Database\Factories\RegimenFiscalFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Override;

final class RegimenFiscal extends Model
{
    /** @use HasFactory<RegimenFiscalFactory> */
    use HasFactory;

    #[Override]
    public $incrementing = false;

    #[Override]
    protected $table = 'regimenes_fiscales';

    #[Override]
    protected $primaryKey = 'clave';

    #[Override]
    protected $keyType = 'string';

    #[Override]
    protected $fillable = [
        'clave',
        'descripcion',
        'aplica_fisica',
        'aplica_moral',
        'vigencia_inicio',
        'vigencia_fin',
    ];

    /**
     * @return array<string, string>
     */
    public function casts(): array
    {
        return [
            'aplica_fisica' => 'boolean',
            'aplica_moral' => 'boolean',
            'vigencia_inicio' => 'date',
            'vigencia_fin' => 'date',
        ];
    }
}
```

<!-- Existing factory pattern. From database/factories/RegimenFiscalFactory.php: -->

```php
<?php
declare(strict_types=1);
namespace Database\Factories;

use App\Models\RegimenFiscal;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<RegimenFiscal> */
final class RegimenFiscalFactory extends Factory
{
    public function definition(): array
    {
        return [
            'clave' => fake()->unique()->regexify('[0-9]{3}'),
            'descripcion' => fake()->sentence(3),
            'aplica_fisica' => fake()->boolean(),
            'aplica_moral' => fake()->boolean(),
            'vigencia_inicio' => null,
            'vigencia_fin' => null,
        ];
    }
}
```

<!-- Existing Filament resource pattern. From app/Filament/Resources/RegimenFiscalResource.php: -->

```php
<?php
declare(strict_types=1);
namespace App\Filament\Resources;

use App\Models\RegimenFiscal;
use BackedEnum;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Table;
use UnitEnum;

final class RegimenFiscalResource extends Resource
{
    protected static ?string $model = RegimenFiscal::class;
    protected static string|BackedEnum|null $navigationIcon = 'heroicon-o-rectangle-stack';
    protected static string|UnitEnum|null $navigationGroup = 'Catálogos SAT';
    // ...
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create migration</name>
  <files>
    composer.json
    composer.lock
    database/migrations/2026_02_28_100000_create_csds_table.php
  </files>
  <action>
**Step 1: Install Composer dependencies via Sail.**

```bash
./vendor/bin/sail composer require phpcfdi/credentials spatie/laravel-data --no-interaction
```

If `spatie/laravel-data` has a PHP 8.5 compatibility issue, try `composer require spatie/laravel-data:^4.0` first. If that fails too, create plain PHP readonly DTO classes instead (note this in the summary and flag for user attention).

**Step 2: Create the csds migration using Artisan.**

```bash
./vendor/bin/sail php artisan make:migration create_csds_table --no-interaction
```

Then customize the migration to match this exact schema:

```php
Schema::create('csds', function (Blueprint $table): void {
    $table->id();
    $table->string('no_certificado', 40)->unique();
    $table->string('rfc', 13);
    $table->date('fecha_inicio');
    $table->date('fecha_fin');
    $table->string('status', 20)->default('inactive');
    $table->string('key_path', 500);
    $table->text('passphrase_encrypted');   // TEXT — encrypted ciphertext is 300-500+ chars
    $table->string('cer_path', 500);        // Path to stored .cer file (for future signing)
    $table->timestamps();
    $table->softDeletes();
    $table->index('status');
    $table->index('fecha_fin');             // For whereExpiring() queries
});
```

**CRITICAL differences from Phase 1 catalog models:**
- Uses auto-increment `id` (NOT string PK) — Csd is NOT a SAT catalog
- `no_certificado` is a unique data field, NOT the primary key
- `passphrase_encrypted` is `text()` NOT `string()` — encrypted ciphertext is longer than plaintext
- Includes `softDeletes()` for audit trail
- Includes `cer_path` to store the .cer file path (needed for XML signing in Phase 4)

Rename the migration file to `2026_02_28_100000_create_csds_table.php` for consistent ordering.

Run the migration:
```bash
./vendor/bin/sail php artisan migrate --force
```

Run `vendor/bin/pint --dirty --format agent` after all PHP file changes.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php artisan migrate:status 2>&1 | grep "csds" && ./vendor/bin/sail php -r "new PhpCfdi\Credentials\Certificate('');" 2>&1 | head -3 && ./vendor/bin/sail php -r "new Spatie\LaravelData\Data();" 2>&1 | head -3</automated>
  </verify>
  <done>phpcfdi/credentials and spatie/laravel-data are installed. csds migration runs without error. Table has id, no_certificado (unique), rfc, fecha_inicio, fecha_fin, status (indexed), key_path, passphrase_encrypted (text), cer_path, timestamps, softDeletes, and fecha_fin index.</done>
</task>

<task type="auto">
  <name>Task 2: Create Csd model, CsdStatus enum, CsdBuilder, CsdFactory, and DTOs</name>
  <files>
    app/Models/Csd.php
    app/Enums/CsdStatus.php
    app/Builders/CsdBuilder.php
    database/factories/CsdFactory.php
    app/Data/UploadCsdData.php
    app/Data/CsdData.php
  </files>
  <action>
**Step 1: Create CsdStatus enum.**

Create `app/Enums/CsdStatus.php`:

```php
declare(strict_types=1);

namespace App\Enums;

use Filament\Support\Contracts\HasColor;
use Filament\Support\Contracts\HasLabel;

enum CsdStatus: string implements HasColor, HasLabel
{
    case Active       = 'active';
    case ExpiringSoon = 'expiring_soon';
    case Expired      = 'expired';
    case Inactive     = 'inactive';

    public function getColor(): string|array|null
    {
        return match ($this) {
            self::Active       => 'success',   // green
            self::ExpiringSoon => 'warning',   // yellow
            self::Expired      => 'danger',    // red
            self::Inactive     => 'gray',
        };
    }

    public function getLabel(): string
    {
        return match ($this) {
            self::Active       => 'Activo',
            self::ExpiringSoon => 'Por vencer',
            self::Expired      => 'Expirado',
            self::Inactive     => 'Inactivo',
        };
    }
}
```

**Step 2: Create CsdBuilder.**

Create `app/Builders/CsdBuilder.php`. This is a NEW directory — create `app/Builders/` first.

```php
declare(strict_types=1);

namespace App\Builders;

use App\Enums\CsdStatus;
use Illuminate\Database\Eloquent\Builder;

/**
 * @template TModelClass of \App\Models\Csd
 * @extends Builder<TModelClass>
 */
final class CsdBuilder extends Builder
{
    public function whereActive(): static
    {
        return $this->where('status', CsdStatus::Active);
    }

    public function whereExpiring(int $withinDays = 90): static
    {
        return $this->where(function (self $query) use ($withinDays): void {
            $query->where('status', CsdStatus::ExpiringSoon)
                ->orWhere(function (self $inner) use ($withinDays): void {
                    $inner->where('status', CsdStatus::Active)
                        ->whereBetween('fecha_fin', [now(), now()->addDays($withinDays)]);
                });
        });
    }

    public function whereNotExpired(): static
    {
        return $this->where('fecha_fin', '>', now());
    }
}
```

**Step 3: Create Csd model.**

Use `php artisan make:model Csd --factory --no-interaction` then customize. The model MUST:
- Be `final class`
- Have `declare(strict_types=1)`
- Use `HasFactory`, `SoftDeletes` traits
- Use `#[UseEloquentBuilder(CsdBuilder::class)]` attribute
- Use standard auto-increment id (do NOT set `$incrementing = false`)
- Cast `passphrase_encrypted` as `'encrypted'` (auto-encrypts on save, auto-decrypts on read)
- Cast `status` as `CsdStatus::class`
- Cast `fecha_inicio` and `fecha_fin` as `'date'`
- `$fillable`: no_certificado, rfc, fecha_inicio, fecha_fin, status, key_path, passphrase_encrypted, cer_path

```php
declare(strict_types=1);

namespace App\Models;

use App\Builders\CsdBuilder;
use App\Enums\CsdStatus;
use Database\Factories\CsdFactory;
use Illuminate\Database\Eloquent\Attributes\UseEloquentBuilder;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Override;

#[UseEloquentBuilder(CsdBuilder::class)]
final class Csd extends Model
{
    /** @use HasFactory<CsdFactory> */
    use HasFactory;
    use SoftDeletes;

    #[Override]
    protected $fillable = [
        'no_certificado',
        'rfc',
        'fecha_inicio',
        'fecha_fin',
        'status',
        'key_path',
        'passphrase_encrypted',
        'cer_path',
    ];

    /**
     * @return array<string, string>
     */
    public function casts(): array
    {
        return [
            'fecha_inicio' => 'date',
            'fecha_fin' => 'date',
            'status' => CsdStatus::class,
            'passphrase_encrypted' => 'encrypted',
        ];
    }
}
```

**Step 4: Create CsdFactory.**

Customize `database/factories/CsdFactory.php`:

```php
declare(strict_types=1);

namespace Database\Factories;

use App\Enums\CsdStatus;
use App\Models\Csd;
use Illuminate\Database\Eloquent\Factories\Factory;

/** @extends Factory<Csd> */
final class CsdFactory extends Factory
{
    public function definition(): array
    {
        return [
            'no_certificado' => fake()->unique()->numerify('####################'),
            'rfc' => fake()->regexify('[A-Z]{4}[0-9]{6}[A-Z0-9]{3}'),
            'fecha_inicio' => now()->subYear(),
            'fecha_fin' => now()->addYears(3),
            'status' => CsdStatus::Inactive,
            'key_path' => 'csd/' . fake()->uuid() . '.key.enc',
            'passphrase_encrypted' => fake()->password(8, 20),
            'cer_path' => 'csd/' . fake()->uuid() . '.cer',
        ];
    }

    public function active(): static
    {
        return $this->state(fn (array $attributes): array => [
            'status' => CsdStatus::Active,
        ]);
    }

    public function expiringSoon(): static
    {
        return $this->state(fn (array $attributes): array => [
            'status' => CsdStatus::ExpiringSoon,
            'fecha_fin' => now()->addDays(30),
        ]);
    }

    public function expired(): static
    {
        return $this->state(fn (array $attributes): array => [
            'status' => CsdStatus::Expired,
            'fecha_fin' => now()->subDay(),
        ]);
    }
}
```

**Step 5: Create DTOs.**

Create `app/Data/` directory, then:

`app/Data/UploadCsdData.php`:
```php
declare(strict_types=1);

namespace App\Data;

use Spatie\LaravelData\Data;

final class UploadCsdData extends Data
{
    public function __construct(
        public string $cerFilePath,
        public string $keyFilePath,
        public string $passphrase,
    ) {}
}
```

`app/Data/CsdData.php`:
```php
declare(strict_types=1);

namespace App\Data;

use App\Enums\CsdStatus;
use Carbon\CarbonInterface;
use Spatie\LaravelData\Data;

final class CsdData extends Data
{
    public function __construct(
        public int $id,
        public string $noCertificado,
        public string $rfc,
        public CarbonInterface $fechaInicio,
        public CarbonInterface $fechaFin,
        public CsdStatus $status,
    ) {}
}
```

Run `vendor/bin/pint --dirty --format agent` after creating all files.
  </action>
  <verify>
    <automated>cd /home/aarongmx/Proyectos/FacturacionLoop && ./vendor/bin/sail php artisan tinker --execute="use App\Models\Csd; use App\Enums\CsdStatus; \$c = Csd::factory()->create(); echo \$c->status instanceof CsdStatus ? 'ENUM_OK' : 'ENUM_FAIL'; echo ' '; echo \$c->id > 0 ? 'ID_OK' : 'ID_FAIL';" && vendor/bin/pint --dirty --format agent 2>&1 | tail -5</automated>
  </verify>
  <done>Csd model creates via factory with auto-increment id. CsdStatus enum has 4 cases with Spanish labels and Filament colors. CsdBuilder has whereActive(), whereExpiring(), whereNotExpired() methods. UploadCsdData and CsdData DTOs exist. All files pass Pint formatting.</done>
</task>

</tasks>

<verification>
- `./vendor/bin/sail composer show phpcfdi/credentials` shows installed version
- `./vendor/bin/sail composer show spatie/laravel-data` shows installed version
- `./vendor/bin/sail php artisan migrate:status` shows csds migration as "Ran"
- `Csd::factory()->create()` succeeds in tinker
- `Csd::factory()->active()->create()` returns a CSD with Active status
- `Csd::query()->whereActive()` executes without error
- `vendor/bin/pint --dirty --format agent` reports no changes needed
- `./vendor/bin/sail php artisan test --compact` passes (no regressions)
</verification>

<success_criteria>
- phpcfdi/credentials and spatie/laravel-data installed
- csds table with correct schema including encrypted passphrase (TEXT), softDeletes, and indexes
- Csd model with encrypted cast, CsdStatus enum cast, date casts, SoftDeletes, UseEloquentBuilder
- CsdStatus enum with HasColor + HasLabel implementing 4 Spanish-labeled color-coded statuses
- CsdBuilder with 3 query methods (whereActive, whereExpiring, whereNotExpired)
- CsdFactory with definition + 3 states (active, expiringSoon, expired)
- UploadCsdData and CsdData DTOs
</success_criteria>

<output>
After completion, create `.planning/phases/02-gesti-n-de-csd/02-01-SUMMARY.md`
</output>
